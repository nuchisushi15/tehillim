<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>מערכת תהילים קהילתית</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #ebf4ff, #c3dafe);
      margin: 0;
      padding: 0;
      direction: rtl;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      background: rgba(255,255,255,0.85);
      border-radius: 18px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      min-height: 100vh;
    }
    h1, h2 {
      color: #4c51bf;
    }
    .btn {
      background: #5a67d8;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 10px 18px;
      font-size: 1em;
      cursor: pointer;
      margin: 5px 0;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #434190;
    }
    .input, input, select {
      width: 100%;
      padding: 9px;
      margin: 4px 0 10px 0;
      border-radius: 6px;
      border: 1px solid #cbd5e0;
      font-size: 1em;
      box-sizing: border-box;
    }
    .stats {
      display: flex;
      gap: 16px;
      margin-bottom: 28px;
      justify-content: center;
    }
    .stat {
      background: #e6fffa;
      color: #2c5282;
      border-radius: 9px;
      padding: 12px 20px;
      text-align: center;
      flex: 1;
    }
    .stat.yellow { background: #fffbea; color: #b7791f; }
    .stat.green { background: #f0fff4; color: #276749; }
    .stat.blue { background: #ebf8ff; color: #2b6cb0; }
    .campaign-list {
      margin: 0 0 32px 0;
    }
    .campaign-card {
      border: 1px solid #cbd5e0;
      border-radius: 9px;
      padding: 10px 15px;
      background: #f7fafc;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .chapter-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 5px;
      margin-bottom: 20px;
      margin-top: 10px;
    }
    .chapter-btn {
      padding: 7px 0;
      font-size: 0.97em;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .chapter-btn.available { background: #f0fff4; color: #276749; }
    .chapter-btn.available:hover { background: #c6f6d5; }
    .chapter-btn.selected { background: #5a67d8; color: #fff; }
    .chapter-btn.taken { background: #fefcbf; color: #b7791f; cursor: not-allowed; }
    .chapter-btn.completed { background: #4299e1; color: #fff; cursor: not-allowed; }
    .chapter-btn .icon { margin-right: 3px; vertical-align: middle; }
    .taken-list { margin-bottom: 24px; }
    .taken-card {
      background: #fefcbf;
      border-radius: 7px;
      padding: 9px 14px;
      margin-bottom: 7px;
      border: 1px solid #faf089;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .taken-card.completed {
      background: #ebf8ff;
      border: 1px solid #bee3f8;
      color: #2b6cb0;
    }
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.48);
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal {
      background: #fff;
      border-radius: 18px;
      padding: 24px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 2px 18px rgba(0,0,0,0.12);
      position: relative;
    }
    .modal .close {
      position: absolute;
      left: 16px;
      top: 12px;
      font-size: 2em;
      color: #718096;
      background: none;
      border: none;
      cursor: pointer;
    }
    .footer {
      text-align: center;
      color: #718096;
      margin-top: 40px;
      font-size: 0.95em;
    }
    pre {
      white-space: pre-wrap;
      font-size: 1em;
      background: #f7fafc;
      border-radius: 8px;
      padding: 10px;
      direction: rtl;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <script>
    // SVG icons for simplicity
    const icons = {
      book: '<svg class="icon" width="22" height="22" fill="none" stroke="#4c51bf" stroke-width="2" viewBox="0 0 24 24"><path d="M2 7V19a2 2 0 002 2h16m0-2V7a2 2 0 00-2-2H4a2 2 0 00-2 2z"/><path d="M6 2v4"/></svg>',
      plus: '<svg class="icon" width="18" height="18" fill="none" stroke="#4c51bf" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>',
      copy: '<svg class="icon" width="18" height="18" fill="none" stroke="#38a169" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><rect x="2" y="2" width="13" height="13" rx="2"/></svg>',
      bell: '<svg class="icon" width="16" height="16" fill="none" stroke="#4c51bf" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>',
      check: '<svg class="icon" width="14" height="14" fill="none" stroke="#3182ce" stroke-width="2" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>',
      clock: '<svg class="icon" width="14" height="14" fill="none" stroke="#b7791f" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
      user: '<svg class="icon" width="16" height="16" fill="none" stroke="#4a5568" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a7 7 0 0113 0"/></svg>',
      heart: '<svg class="icon" width="16" height="16" fill="none" stroke="#e53e3e" stroke-width="2" viewBox="0 0 24 24"><path d="M12 21C12 21 5 14.5 5 9.5A4.5 4.5 0 0112 5a4.5 4.5 0 017 4.5C19 14.5 12 21 12 21z"/></svg>',
    };

    // --- Sefaria fetch ---
    let sefariaText = null;
    fetch('https://www.sefaria.org/api/v3/texts/tref', { method: 'GET', headers: { accept: 'application/json' } })
      .then(res => res.json())
      .then(res => {
        sefariaText = res;
        render();
      })
      .catch(err => {
        sefariaText = { error: err.message };
        render();
      });

    // --- App State ---
    let campaigns = {};
    let currentCampaign = null;
    let showCreateForm = false;
    let selectedChapters = [];
    let userName = '';
    let userEmail = '';
    let showChapterText = null;
    // Campaign form
    let campaignName = '';
    let prayerFor = '';
    let creatorName = '';
    let creatorEmail = '';

    // --- Helper Functions ---
    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }
    function resetForm() {
      campaignName = '';
      prayerFor = '';
      creatorName = '';
      creatorEmail = '';
    }
    function alertMsg(msg) {
      window.alert(msg);
    }

    // --- Render Function ---
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = '';

      // If modal open
      if (showChapterText !== null) {
        renderModal(app);
        return;
      }

      // --- Main screen ---
      if (!currentCampaign) {
        const mainDiv = document.createElement('div');
        // Header
        mainDiv.innerHTML += `
          <div style="text-align:center; margin-bottom:32px;">
            <h1 style="font-size:2.2em; font-weight:bold;">${icons.book} מערכת תהילים קהילתית</h1>
            <div style="color:#5a67d8; font-size:1.15em;">צור מסע תהילים חדש או הצטרף לקיים</div>
          </div>
        `;

        // Sefaria preview
        mainDiv.innerHTML += `
          <div style="background:#fff; border-radius:10px; box-shadow:0 1px 6px #e2e8f0; padding:18px; margin-bottom:25px;">
            <h2 style="font-size:1.08em; font-weight:bold; margin-bottom:7px;">טקסט מספאריה</h2>
            ${sefariaText
              ? sefariaText.error
                ? `<div style="color:#e53e3e;">שגיאת טעינה: ${sefariaText.error}</div>`
                : `<pre>${JSON.stringify(sefariaText, null, 2)}</pre>`
              : '<div>טוען טקסט מספאריה...</div>'}
          </div>
        `;

        // Grid: create/join
        const gridDiv = document.createElement('div');
        gridDiv.style.display = 'flex';
        gridDiv.style.gap = '24px';
        gridDiv.style.flexWrap = 'wrap';

        // --- Create Campaign ---
        const createDiv = document.createElement('div');
        createDiv.style.flex = '1';
        createDiv.style.minWidth = '270px';
        createDiv.style.background = '#fff';
        createDiv.style.borderRadius = '10px';
        createDiv.style.boxShadow = '0 1px 6px #e2e8f0';
        createDiv.style.padding = '18px';
        createDiv.innerHTML = `
          <h2 style="font-size:1.25em; font-weight:bold;">${icons.plus} צור מסע חדש</h2>
        `;
        if (!showCreateForm) {
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.textContent = 'צור מסע תהילים';
          btn.onclick = () => { showCreateForm = true; render(); };
          createDiv.appendChild(btn);
        } else {
          createDiv.innerHTML += `
            <input class="input" type="text" id="campaignName" placeholder="שם המסע (לדוגמה: תהילים לרפואה)" value="${campaignName}">
            <input class="input" type="text" id="prayerFor" placeholder="למי מתפללים? (לדוגמה: יוסף בן מרים)" value="${prayerFor}">
            <input class="input" type="text" id="creatorName" placeholder="השם שלך" value="${creatorName}">
            <input class="input" type="email" id="creatorEmail" placeholder="האימייל שלך (אופציונלי)" value="${creatorEmail}">
            <div style="display:flex; gap:7px;">
              <button class="btn" id="createBtn">צור מסע</button>
              <button class="btn" style="background:#e2e8f0; color:#2d3748;" id="cancelBtn">ביטול</button>
            </div>
          `;
          // Attach events after DOM insert
          setTimeout(() => {
            document.getElementById('campaignName').oninput = e => { campaignName = e.target.value; };
            document.getElementById('prayerFor').oninput = e => { prayerFor = e.target.value; };
            document.getElementById('creatorName').oninput = e => { creatorName = e.target.value; };
            document.getElementById('creatorEmail').oninput = e => { creatorEmail = e.target.value; };
            document.getElementById('createBtn').onclick = () => {
              if (!campaignName || !prayerFor || !creatorName) {
                alertMsg('נא למלא את כל השדות');
                return;
              }
              const id = generateId();
              const newCampaign = {
                id,
                name: campaignName,
                prayerFor,
                creatorName,
                creatorEmail,
                createdAt: new Date().toLocaleDateString('he-IL'),
                chapters: {}
              };
              for (let i = 1; i <= 150; i++) {
                newCampaign.chapters[i] = {
                  id: i,
                  available: true,
                  takenBy: '',
                  email: '',
                  completed: false,
                  takenAt: null
                };
              }
              campaigns[id] = newCampaign;
              currentCampaign = id;
              showCreateForm = false;
              resetForm();
              render();
            };
            document.getElementById('cancelBtn').onclick = () => {
              showCreateForm = false;
              render();
            };
          }, 50);
        }
        gridDiv.appendChild(createDiv);

        // --- Existing Campaigns ---
        const existDiv = document.createElement('div');
        existDiv.style.flex = '1';
        existDiv.style.minWidth = '270px';
        existDiv.style.background = '#fff';
        existDiv.style.borderRadius = '10px';
        existDiv.style.boxShadow = '0 1px 6px #e2e8f0';
        existDiv.style.padding = '18px';
        existDiv.innerHTML = `<h2 style="font-size:1.15em; font-weight:bold;">מסעות פעילים</h2>`;
        const keys = Object.keys(campaigns);
        if (keys.length === 0) {
          existDiv.innerHTML += `<div style="text-align:center; color:#718096; padding:25px;">אין מסעות פעילים כרגע</div>`;
        } else {
          const listDiv = document.createElement('div');
          listDiv.className = 'campaign-list';
          keys.forEach(k => {
            const campaign = campaigns[k];
            const completed = Object.values(campaign.chapters).filter(ch => ch.completed).length;
            const taken = Object.values(campaign.chapters).filter(ch => !ch.available && !ch.completed).length;
            const card = document.createElement('div');
            card.className = 'campaign-card';
            card.innerHTML = `
              <div>
                <div style="font-weight:bold;">${campaign.name}</div>
                <div style="color:#5a67d8;">עבור: ${campaign.prayerFor}</div>
                <div style="color:#718096; font-size:0.9em;">הושלמו: ${completed} | נלקחו: ${taken}</div>
              </div>
              <button class="btn" style="background:#ebf4ff; color:#4c51bf;" id="join_${k}">הצטרף</button>
            `;
            setTimeout(() => {
              document.getElementById(`join_${k}`).onclick = () => {
                currentCampaign = campaign.id;
                render();
              };
            }, 10);
            listDiv.appendChild(card);
          });
          existDiv.appendChild(listDiv);
        }
        gridDiv.appendChild(existDiv);

        mainDiv.appendChild(gridDiv);

        // Footer
        const footer = document.createElement('div');
        footer.className = 'footer';
        footer.innerHTML = `${icons.heart} נוצר לזכות הרבים`;
        mainDiv.appendChild(footer);

        app.appendChild(mainDiv);
        return;
      }

      // --- Campaign View ---
      const campaign = campaigns[currentCampaign];
      const available = Object.values(campaign.chapters).filter(ch => ch.available).length;
      const taken = Object.values(campaign.chapters).filter(ch => !ch.available && !ch.completed).length;
      const completed = Object.values(campaign.chapters).filter(ch => ch.completed).length;

      // Back button, name, copy link
      const headerDiv = document.createElement('div');
      headerDiv.style.textAlign = 'center';
      headerDiv.style.marginBottom = '14px';
      headerDiv.innerHTML = `
        <button class="btn" style="background:#ebf4ff; color:#4c51bf; margin-bottom:7px;" id="backBtn">← חזור למסעות</button>
        <h1 style="font-size:1.35em; font-weight:bold; margin:7px 0 5px 0;">${campaign.name}</h1>
        <div style="color:#5a67d8; font-size:1.08em; margin-bottom:8px;">תהילים עבור: <span style="font-weight:bold;">${campaign.prayerFor}</span></div>
        <button class="btn" style="background:#e6fffa; color:#38a169;" id="copyBtn">${icons.copy} העתק קישור</button>
      `;
      setTimeout(() => {
        document.getElementById('backBtn').onclick = () => { currentCampaign = null; render(); };
        document.getElementById('copyBtn').onclick = () => {
          const link = `${window.location.origin}${window.location.pathname}?campaign=${currentCampaign}`;
          navigator.clipboard.writeText(link);
          alertMsg('הקישור הועתק!');
        };
      }, 30);
      app.appendChild(headerDiv);

      // Stats
      const statsDiv = document.createElement('div');
      statsDiv.className = 'stats';
      statsDiv.innerHTML = `
        <div class="stat green"><div style="font-size:1.3em;">${available}</div>זמינים</div>
        <div class="stat yellow"><div style="font-size:1.3em;">${taken}</div>נלקחו</div>
        <div class="stat blue"><div style="font-size:1.3em;">${completed}</div>הושלמו</div>
      `;
      app.appendChild(statsDiv);

      // --- Take Chapters ---
      const takeDiv = document.createElement('div');
      takeDiv.style.background = '#fff';
      takeDiv.style.borderRadius = '10px';
      takeDiv.style.boxShadow = '0 1px 6px #e2e8f0';
      takeDiv.style.padding = '18px';
      takeDiv.style.marginBottom = '22px';
      takeDiv.innerHTML = `<h2 style="font-size:1.07em; font-weight:bold;">בחר פרקים</h2>
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:14px;">
          <input class="input" type="text" id="userName" placeholder="השם שלך" value="${userName}">
          <input class="input" type="email" id="userEmail" placeholder="האימייל שלך" value="${userEmail}">
          <button class="btn" id="claimBtn" ${selectedChapters.length === 0 || !userName || !userEmail ? 'disabled style="background:#e2e8f0;color:#718096;"' : ''}>${icons.bell} קח פרקים (${selectedChapters.length})</button>
        </div>
        <div class="chapter-grid" id="chapGrid"></div>
      `;
      setTimeout(() => {
        document.getElementById('userName').oninput = e => { userName = e.target.value; };
        document.getElementById('userEmail').oninput = e => { userEmail = e.target.value; };
        document.getElementById('claimBtn').onclick = () => {
          if (!userName || !userEmail || selectedChapters.length === 0) {
            alertMsg('נא למלא שם, אימייל ולבחור פרקים');
            return;
          }
          const timestamp = new Date().toLocaleDateString('he-IL');
          selectedChapters.forEach(chapterNum => {
            campaign.chapters[chapterNum].available = false;
            campaign.chapters[chapterNum].takenBy = userName;
            campaign.chapters[chapterNum].email = userEmail;
            campaign.chapters[chapterNum].takenAt = timestamp;
          });
          selectedChapters = [];
          userName = '';
          userEmail = '';
          alertMsg('הפרקים נשמרו בהצלחה!');
          render();
        };
        // Chapters grid
        const chapGrid = document.getElementById('chapGrid');
        chapGrid.innerHTML = '';
        Object.values(campaign.chapters).forEach(chapter => {
          const btn = document.createElement('button');
          btn.className = 'chapter-btn';
          btn.textContent = chapter.id;
          if (chapter.completed) {
            btn.classList.add('completed');
            btn.title = `הושלם על ידי ${chapter.takenBy}`;
            btn.innerHTML += icons.check;
            btn.disabled = true;
          } else if (!chapter.available) {
            btn.classList.add('taken');
            btn.title = `נלקח על ידי ${chapter.takenBy}`;
            btn.innerHTML += icons.clock;
            btn.disabled = true;
          } else if (selectedChapters.includes(chapter.id)) {
            btn.classList.add('selected');
            btn.title = 'נבחר';
          } else {
            btn.classList.add('available');
            btn.title = 'זמין';
          }
          btn.onclick = () => {
            if (!chapter.available) return;
            if (selectedChapters.includes(chapter.id)) {
              selectedChapters = selectedChapters.filter(ch => ch !== chapter.id);
            } else {
              selectedChapters.push(chapter.id);
            }
            render();
          };
          chapGrid.appendChild(btn);
        });
      }, 50);
      app.appendChild(takeDiv);

      // --- Taken Chapters ---
      const takenDiv = document.createElement('div');
      takenDiv.style.background = '#fff';
      takenDiv.style.borderRadius = '10px';
      takenDiv.style.boxShadow = '0 1px 6px #e2e8f0';
      takenDiv.style.padding = '18px';
      takenDiv.innerHTML = `<h2 style="font-size:1.07em; font-weight:bold;">פרקים שנלקחו</h2>`;
      const takenChapters = Object.values(campaign.chapters).filter(ch => !ch.available);
      if (takenChapters.length === 0) {
        takenDiv.innerHTML += `<div style="text-align:center; color:#718096; padding:16px;">אין פרקים שנלקחו עדיין</div>`;
      } else {
        const listDiv = document.createElement('div');
        listDiv.className = 'taken-list';
        takenChapters.sort((a,b) => a.id - b.id).forEach(chapter => {
          const card = document.createElement('div');
          card.className = 'taken-card';
          if (chapter.completed) card.classList.add('completed');
          card.innerHTML = `
            <div>
              <span style="font-weight:bold;">פרק ${chapter.id}</span>
              <span style="color:#718096; margin-right:7px;">${icons.user} ${chapter.takenBy}</span>
              ${chapter.completed ? `<span style="color:#3182ce;">${icons.check} הושלם</span>` : ''}
            </div>
            <div>
              <button class="btn" style="background:#ebf4ff; color:#4c51bf; font-size:0.92em;" id="showText_${chapter.id}">הצג טקסט</button>
              ${!chapter.completed ? `<button class="btn" style="background:#f0fff4; color:#38a169; font-size:0.92em;" id="finish_${chapter.id}">סיימתי</button>` : ''}
            </div>
          `;
          setTimeout(() => {
            document.getElementById(`showText_${chapter.id}`).onclick = () => {
              showChapterText = chapter.id;
              render();
            };
            if (!chapter.completed) {
              document.getElementById(`finish_${chapter.id}`).onclick = () => {
                campaign.chapters[chapter.id].completed = true;
                alertMsg(`פרק ${chapter.id} הושלם!`);
                render();
              };
            }
          }, 20);
          listDiv.appendChild(card);
        });
        takenDiv.appendChild(listDiv);
      }
      app.appendChild(takenDiv);

      // Footer
      const footer = document.createElement('div');
      footer.className = 'footer';
      footer.innerHTML = `${icons.heart} נוצר לזכות הרבים • מתפללים עבור ${campaign.prayerFor}`;
      app.appendChild(footer);
    }

    // --- Modal for Chapter Text ---
    function renderModal(app) {
      const campaign = campaigns[currentCampaign];
      const chapterNum = showChapterText;
      const chapter = campaign.chapters[chapterNum];
      // Use Sefaria text if available
      let textBlock = '';
      if (sefariaText && sefariaText.text) {
        textBlock = `<pre>${Array.isArray(sefariaText.text) ? sefariaText.text.join('\n') : sefariaText.text}</pre>`;
      } else {
        textBlock = `<div>טקסט של פרק ${chapterNum} יוצג כאן...</div>`;
      }
      const modalBg = document.createElement('div');
      modalBg.className = 'modal-bg';

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <button class="close" id="modalClose">&times;</button>
        <h3 style="font-size:1.07em; font-weight:bold; margin-bottom:13px;">פרק ${chapterNum}</h3>
        <div style="margin-bottom:12px;">${textBlock}</div>
        <div style="text-align:center;">
          <button class="btn" style="margin-top:11px;" id="finishModalBtn">${icons.check} סיימתי את הפרק</button>
        </div>
      `;
      setTimeout(() => {
        document.getElementById('modalClose').onclick = () => {
          showChapterText = null;
          render();
        };
        document.getElementById('finishModalBtn').onclick = () => {
          campaign.chapters[chapterNum].completed = true;
          showChapterText = null;
          alertMsg(`פרק ${chapterNum} הושלם!`);
          render();
        };
      }, 25);

      modalBg.appendChild(modal);
      app.appendChild(modalBg);
    }

    // ---- Initial Render ----
    render();
  </script>
</body>
</html>
