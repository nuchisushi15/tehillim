<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™× â€” ×¢×™×¦×•×‘ ×—×“×©</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --brand:#6d28d9;
      --brand-2:#7c3aed;
      --accent:#10b981;
      --danger:#ef4444;
      --ring:rgba(109,40,217,.18);
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Hebrew", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      background: radial-gradient(1000px 600px at 80% -200px, #ede9fe 0%, transparent 70%), var(--bg);
      color:var(--ink);
    }

    .shell{
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height:100vh;
    }
    @media (max-width: 960px){
      .shell{grid-template-columns: 1fr}
      .sidebar{position:static; height:auto}
    }

    header.topbar{
      grid-column: 1 / -1;
      position: sticky;
      top:0;
      z-index: 5;
      background: rgba(255,255,255,.7);
      backdrop-filter: saturate(180%) blur(12px);
      border-bottom: 1px solid #e5e7eb;
    }
    .topbar-inner{
      max-width: 1200px;
      margin:0 auto;
      padding:14px 20px;
      display:flex;
      align-items:center;
      gap:16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:800;
      color:var(--brand);
      letter-spacing:.2px;
    }
    .brand .logo{
      width:36px; height:36px; border-radius:10px;
      background: conic-gradient(from 220deg, var(--brand), var(--brand-2));
      box-shadow: 0 8px 18px var(--ring);
    }
    .top-actions{margin-inline-start:auto; display:flex; gap:8px}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer;
      background:var(--brand); color:white;
      box-shadow: 0 6px 16px var(--ring);
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.secondary{background:#111827; color:#fff; box-shadow:none}
    .btn.ghost{background:transparent; color:var(--brand); box-shadow:none}
    .btn.success{background:var(--accent)}
    .btn.danger{background:var(--danger)}

    .sidebar{
      position: sticky; top:60px; align-self:start;
      height: calc(100vh - 60px);
      padding:20px;
      border-inline-end:1px solid #e5e7eb;
      background:linear-gradient(180deg, rgba(124,58,237,.06), transparent 180px);
    }
    .card{
      background:var(--card); border:1px solid #eef0f6; border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .panel{padding:18px}
    .panel h3{margin:0 0 8px; font-size:18px}
    .muted{color:var(--muted)}
    .hr{height:1px; background:#eef0f6; margin:12px 0}

    .form{display:grid; gap:12px}
    .row{display:grid; gap:6px}
    label{font-size:13px; color:#374151; font-weight:600}
    input, textarea, select{
      background:#fff; border:1.5px solid #e5e7eb; border-radius:12px; padding:12px 14px; font:inherit;
      outline:none; transition: border .15s, box-shadow .15s;
    }
    textarea{min-height:84px; resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:var(--brand); box-shadow: 0 0 0 4px var(--ring)}
    .helper{font-size:12px; color:var(--muted)}

    .campaigns{
      margin-top:16px; display:flex; flex-direction:column; gap:10px; max-height:40vh; overflow:auto;
    }
    .camp-item{
      padding:12px; border-radius:14px; border:1px solid #e5e7eb; background:#fff; cursor:pointer;
      display:flex; flex-direction:column; gap:6px; transition: background .15s, transform .06s;
    }
    .camp-item:hover{background:#fafafa; transform: translateY(-1px)}
    .caption{font-size:12px; color:var(--muted)}

    .main{
      padding:24px; max-width: 1000px; width:100%;
    }
    .hero{
      display:flex; flex-direction:column; gap:10px; margin-bottom:18px;
    }
    .hero h2{margin:0}
    .info-banner{
      padding:14px; border-radius:14px; background:#f0fdfa; border:1px solid #ccfbf1; color:#065f46;
    }

    .grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(54px, 1fr)); gap:10px;
    }
    .chip{
      user-select:none;
      text-align:center; padding:12px 6px; border-radius:14px; border:1.5px solid #e5e7eb; background:#fff;
      font-weight:800; letter-spacing:.3px;
      transition: transform .06s, border .15s, background .15s, color .15s;
      cursor:pointer;
    }
    .chip:hover{transform: translateY(-1px); border-color:var(--brand)}
    .chip.taken{background:#eef2ff; border-color:#c7d2fe; color:#4338ca}
    .chip.completed{background:#e5efe7; border-color:#a7f3d0; color:#065f46}

    .progress{
      display:flex; align-items:center; gap:14px; margin:14px 0 8px;
    }
    .bar{flex:1; height:14px; background:#eef0f6; border-radius:999px; overflow:hidden}
    .fill{height:100%; width:0; background:linear-gradient(90deg, var(--accent), #34d399); transition: width .45s ease}

    .section{margin-top:18px}
    .stack{display:grid; gap:12px}

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.on{ display:flex }
    .backdrop{ position:absolute; inset:0; background:rgba(17,24,39,.55); backdrop-filter: blur(4px); }
    .dialog{ position:relative; width:min(720px, 92vw); max-height:85vh; overflow:auto; background:var(--card); border-radius:20px; box-shadow: 0 20px 60px rgba(17,24,39,.35); }
    .dialog header{ position:sticky; top:0; background:#fff; padding:16px; border-bottom:1px solid #eef0f6; border-radius:20px 20px 0 0}
    .dialog .content{ padding:18px; white-space:pre-wrap; line-height:2; font-size:18px }
    .close-x{ position:absolute; left:14px; top:12px; background:transparent; border:0; font-size:22px; cursor:pointer }

    .pill{
      display:inline-flex; gap:8px; align-items:center; font-size:12px;
      padding:6px 10px; border-radius:999px; background:#f5f3ff; color:#4c1d95; border:1px solid #ddd6fe;
    }

    .urlbox{padding:10px 12px; background:#f9fafb; border:1px dashed var(--brand); border-radius:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; direction:ltr}

    .subtle{color:#4b5563; font-size:13px}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand"><div class="logo"></div> ×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™×</div>
      <div class="top-actions">
        <button class="btn ghost" onclick="scrollTo({top:0,behavior:'smooth'})">×œ××¢×œ×”</button>
        <button class="btn success" onclick="showCreateForm()">×§××¤×™×™×Ÿ ×—×“×©</button>
      </div>
    </div>
  </header>

  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="card panel">
        <h3>×™×¦×™×¨×ª ×§××¤×™×™×Ÿ</h3>
        <p class="muted">×‘×—×¨ ×©×, ×”×–×Ÿ ×¤×¨×˜×™ ×××¨×’×Ÿ, ×•×§×‘×œ ×§×™×©×•×¨ ×œ×©×™×ª×•×£.</p>
        <div class="hr"></div>
        <form id="campaignForm" class="form">
          <div class="row">
            <label for="campaignName">×©× ×”×§××¤×™×™×Ÿ</label>
            <input id="campaignName" type="text" placeholder="×œ×¨×¤×•××ª... / ×œ×¢×´× ... / ×œ×–×›×•×ª..." required />
          </div>
          <div class="row">
            <label for="campaignDescription">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</label>
            <textarea id="campaignDescription" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ ×”×§××¤×™×™×Ÿ..."></textarea>
          </div>
          <div class="row">
            <label for="organizerName">×©× ×”×××¨×’×Ÿ</label>
            <input id="organizerName" type="text" required />
          </div>
          <div class="row">
            <label for="organizerEmail">××™×™×œ ×”×××¨×’×Ÿ</label>
            <input id="organizerEmail" type="email" placeholder="name@email.com" required />
            <div class="helper">×™×©×œ×— ×œ×©× ×§×™×©×•×¨ ×œ× ×™×”×•×œ ×”×§××¤×™×™×Ÿ</div>
          </div>
          <button class="btn" type="submit">×¦×•×¨ ×§××¤×™×™×Ÿ</button>
        </form>
      </div>

      <div class="card panel" style="margin-top:14px">
        <h3>×§××¤×™×™× ×™× ×§×™×™××™×</h3>
        <div id="campaignsList" class="campaigns">
          <div class="muted">××™×Ÿ ×§××¤×™×™× ×™× ×§×™×™××™×</div>
        </div>
      </div>

      <div class="card panel" style="margin-top:14px">
        <h3>×”×’×“×¨×ª ×“×•××´×œ</h3>
        <p class="subtle">EmailJS × ×“×¨×© ×œ×©×œ×™×—×ª ×”×ª×¨××•×ª ×•×˜×§×¡×˜ ×”×¤×¨×§.</p>
        <div class="hr"></div>
        <div class="stack">
          <div class="row">
            <label for="emailjsUserId">Public Key</label>
            <input id="emailjsUserId" type="text" value="d_LsqV-KBZuAeuCjf">
          </div>
          <div class="row">
            <label for="emailjsServiceId">Service ID</label>
            <input id="emailjsServiceId" type="text" value="service_p76h23d">
          </div>
          <div class="row">
            <label for="campaignCreatedTemplateId">×ª×‘× ×™×ª: ×™×¦×™×¨×ª ×§××¤×™×™×Ÿ</label>
            <input id="campaignCreatedTemplateId" type="text" value="template_0hmmrlk">
          </div>
          <div class="row">
            <label for="chapterTakenTemplateId">×ª×‘× ×™×ª: × ×˜×™×œ×ª ×¤×¨×§</label>
            <input id="chapterTakenTemplateId" type="text" value="template_swui2zf">
          </div>
          <div class="row">
            <label for="chapterCompletedTemplateId">×ª×‘× ×™×ª: ×”×©×œ××ª ×¤×¨×§</label>
            <input id="chapterCompletedTemplateId" type="text" value="template_j01dkdf">
          </div>
          <div style="display:flex; gap:8px">
            <button class="btn" onclick="saveEmailConfig()">×©××•×¨</button>
            <button class="btn ghost" onclick="testEmailConnection()">×‘×“×™×§×ª ×©×œ×™×—×”</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="hero">
        <h2>×§××¤×™×™×Ÿ ×ª×”×™×œ×™×</h2>
        <div class="info-banner">
          <b>××™×š ×–×” ×¢×•×‘×“?</b> ×™×•×¦×¨×™× ×§××¤×™×™×Ÿ, ××©×ª×¤×™× ××ª ×”×§×™×©×•×¨, ×›×œ ××©×ª×ª×£ ×œ×•×§×— ×¤×¨×§ (××¡×•××Ÿ ×‘××•×ª×™×•×ª ×-×ª),
          ××§×‘×œ ××ª ×”×˜×§×¡×˜ ×‘××™×™×œ ×•××¡××Ÿ ×”×©×œ××” ×‘×¡×™×•×.
        </div>
      </div>

      <!-- Share URL -->
      <section id="urlSection" class="card panel" style="display:none">
        <h3>×§××¤×™×™×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”</h3>
        <p class="muted">×©×ª×¤×• ××ª ×”×§×™×©×•×¨ ×›×“×™ ×œ×¦×¨×£ ××©×ª×ª×¤×™×.</p>
        <div class="urlbox" id="campaignUrl"></div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button class="btn secondary" onclick="copyUrl()">×”×¢×ª×§ ×§×™×©×•×¨</button>
          <button class="btn" onclick="goToCampaign()">××¢×‘×¨ ×œ×§××¤×™×™×Ÿ</button>
        </div>
      </section>

      <!-- Campaign View -->
      <section id="campaignSection" class="card panel" style="display:none">
        <div id="campaignInfo" class="stack"></div>

        <div class="card panel" style="background:#faf5ff; border-color:#e9d5ff; margin-top:10px">
          <h3>×œ×¤× ×™ × ×˜×™×œ×ª ×¤×¨×§</h3>
          <div class="stack">
            <div class="row">
              <label for="participantName">×©××š</label>
              <input id="participantName" type="text" placeholder="×©× ××œ×">
            </div>
            <div class="row">
              <label for="participantEmail">×“×•××´×œ</label>
              <input id="participantEmail" type="email" placeholder="name@email.com">
            </div>
            <div class="pill">×œ××—×¨ ××™×œ×•×™ ×”×¤×¨×˜×™×, ×œ×—×¥ ×¢×œ ××•×ª ×¤×¨×§ ×œ×‘×—×™×¨×”</div>
          </div>
        </div>

        <div class="progress">
          <div id="progressText" class="muted"></div>
          <div class="bar"><div id="progressFill" class="fill"></div></div>
        </div>

        <div class="section">
          <h3>×‘×—×¨×• ×¤×¨×§×™ ×ª×”×™×œ×™×</h3>
          <p class="subtle">×œ×—×™×¦×” ×¢×œ ×”××•×ª ×œ×•×§×—×ª ××ª ×”×¤×¨×§ ×¢×œ ××—×¨×™×•×ª×›×. ×ª×§×‘×œ×• ××ª ×”×˜×§×¡×˜ ×”××œ× ×‘×“×•××´×œ.</p>
          <div id="chaptersGrid" class="grid" style="margin-top:10px"></div>
        </div>

        <div style="display:flex; gap:8px; margin-top:14px">
          <button class="btn secondary" onclick="shareUrl()">×©×™×ª×•×£ ×§××¤×™×™×Ÿ</button>
          <button class="btn ghost" onclick="showCreateForm()">×§××¤×™×™×Ÿ ×—×“×©</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div id="chapterModal" class="modal" role="dialog" aria-modal="true">
    <div class="backdrop" onclick="closeChapterModal()"></div>
    <div class="dialog">
      <header>
        <button class="close-x" onclick="closeChapterModal()" aria-label="×¡×’×•×¨">Ã—</button>
        <h3 id="chapterTitle" style="margin:0"></h3>
      </header>
      <div id="chapterContent" class="content"></div>
      <div style="display:flex; gap:8px; padding:0 18px 18px 18px">
        <button class="btn success" id="completeChapterBtn">×¡×™×™××ª×™ ×œ×§×¨×•× â€” ×¡××Ÿ ×›××•×©×œ×</button>
        <button class="btn ghost" onclick="closeChapterModal()">×¡×’×•×¨</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Hebrew numerals ---------- */
    const H_UNITS = {1:'×',2:'×‘',3:'×’',4:'×“',5:'×”',6:'×•',7:'×–',8:'×—',9:'×˜'};
    const H_TENS = {10:'×™',20:'×›',30:'×œ',40:'×',50:'× ',60:'×¡',70:'×¢',80:'×¤',90:'×¦'};
    const H_HUND = {100:'×§',200:'×¨',300:'×©',400:'×ª'};
    function toHebNum(n, punctuation=true){
      let result = '';
      let num = n;
      [400,300,200,100].forEach(h=>{
        while(num>=h){ result += H_HUND[h]; num -= h; }
      });
      if (num === 15){ result += '×˜×•'; num = 0; }
      else if (num === 16){ result += '×˜×–'; num = 0; }
      else{
        [90,80,70,60,50,40,30,20,10].forEach(t=>{
          while(num>=t){ result += H_TENS[t]; num -= t; }
        });
      }
      if (num>0) result += H_UNITS[num] || '';
      if (!punctuation) return result;
      if (result.length >= 2){
        return result.slice(0,-1) + '×´' + result.slice(-1);
      }else if (result.length === 1){
        return result + '×³';
      }
      return result;
    }

    class TehillimPlatform {
      constructor(){
        this.currentCampaignId = null;
        this.currentChapterNum = null;
        this.emailConfig = null;
        this.tehillimTexts = this.getTehillimTexts();
        this.init();
      }

      init(){
        this.loadEmailConfig();
        if (typeof emailjs !== 'undefined') this.initEmailJS();
        this.setupEventListeners();
        this.loadFromUrl();
        this.displayExistingCampaigns();
      }

      setupEventListeners(){
        document.getElementById('campaignForm').addEventListener('submit', (e)=>{
          e.preventDefault();
          this.createCampaign();
        });
        window.addEventListener('keydown', (e)=>{ if (e.key==='Escape') this.closeChapterModal(); });
      }

      loadEmailConfig(){
        const def = {
          userId: 'd_LsqV-KBZuAeuCjf',
          serviceId: 'service_p76h23d',
          campaignCreatedTemplateId: 'template_0hmmrlk',
          chapterTakenTemplateId: 'template_swui2zf',
          chapterCompletedTemplateId: 'template_j01dkdf'
        };
        const saved = localStorage.getItem('tehillimEmailConfig');
        this.emailConfig = saved ? {...def, ...JSON.parse(saved)} : def;
        if (!saved) localStorage.setItem('tehillimEmailConfig', JSON.stringify(def));
      }

      initEmailJS(){
        try{
          emailjs.init(this.emailConfig.userId);
        }catch(_){
          try{ emailjs.init({ publicKey: this.emailConfig.userId }); } catch(e){ console.error(e); }
        }
      }

      loadFromUrl(){
        const urlParams = new URLSearchParams(location.search);
        const campaignId = urlParams.get('campaign');
        if (campaignId) this.loadCampaign(campaignId);
      }

      getCampaigns(){
        const data = localStorage.getItem('tehillimCampaigns');
        return data ? JSON.parse(data) : {};
      }
      saveCampaigns(c){ localStorage.setItem('tehillimCampaigns', JSON.stringify(c)); }

      createCampaign(){
        const name = document.getElementById('campaignName').value.trim();
        const description = document.getElementById('campaignDescription').value.trim();
        const organizer = document.getElementById('organizerName').value.trim();
        const organizerEmail = document.getElementById('organizerEmail').value.trim();
        if (!name || !organizer || !organizerEmail){
          alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×'); return;
        }
        const id = this.generateId();
        const campaign = {
          id, name, description, organizer, organizerEmail,
          created: new Date().toISOString(),
          chapters: this.initializeChapters()
        };
        const campaigns = this.getCampaigns();
        campaigns[id] = campaign;
        this.saveCampaigns(campaigns);

        this.sendCampaignCreatedEmail(campaign);
        this.showCampaignUrl(id);
        document.getElementById('campaignForm').reset();
        this.displayExistingCampaigns();
      }

      showCampaignUrl(id){
        const base = location.origin + location.pathname;
        const url = `${base}?campaign=${id}`;
        document.getElementById('campaignUrl').textContent = url;
        document.getElementById('urlSection').style.display = '';
        this.currentCampaignId = id;
      }

      loadCampaign(id){
        const campaigns = this.getCampaigns();
        const c = campaigns[id];
        if (!c){ alert('×§××¤×™×™×Ÿ ×œ× × ××¦×'); return; }
        this.currentCampaignId = id;
        this.displayCampaign(c);
      }

      displayCampaign(campaign){
        document.getElementById('urlSection').style.display = 'none';
        document.getElementById('campaignSection').style.display = '';

        const info = document.getElementById('campaignInfo');
        info.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <h3 style="margin:0">${campaign.name}</h3>
            <span class="pill">× ×•×¦×¨: ${new Date(campaign.created).toLocaleDateString('he-IL')}</span>
          </div>
          ${campaign.description ? `<div class="muted">${campaign.description}</div>` : ''}
          <div class="subtle">×××¨×’×Ÿ: <b>${campaign.organizer}</b></div>
        `;

        this.displayChapters(campaign.chapters);
        this.updateProgress(campaign.chapters);
      }

      displayChapters(chapters){
        const grid = document.getElementById('chaptersGrid');
        grid.innerHTML = '';
        for (let i=1;i<=150;i++){
          const ch = chapters[i];
          const div = document.createElement('div');
          div.className = `chip ${ch.status}`;
          div.textContent = toHebNum(i);
          if (ch.status==='taken') div.title = `× ×œ×§×— ×¢×œ ×™×“×™: ${ch.takenBy || '××œ××•× ×™'}`;
          if (ch.status==='completed') div.title = `×”×•×©×œ× ×¢×œ ×™×“×™: ${ch.takenBy || '××œ××•× ×™'}`;
          div.onclick = ()=> this.handleChapterClick(i);
          grid.appendChild(div);
        }
      }

      updateProgress(chapters){
        const total = 150;
        const taken = Object.values(chapters).filter(ch => ch.status!=='available').length;
        const available = total - taken;
        const pct = Math.round((taken/total)*100);
        document.getElementById('progressText').textContent = `× ×œ×§×—×•: ${toHebNum(taken, false)} | ×–××™× ×™×: ${toHebNum(available, false)} | ×¡×”×´×›: ${toHebNum(total, false)} (${pct}%)`;
        document.getElementById('progressFill').style.width = `${pct}%`;
      }

      handleChapterClick(chapterNum){
        const campaigns = this.getCampaigns();
        const c = campaigns[this.currentCampaignId];
        const chapter = c.chapters[chapterNum];
        if (chapter.status==='available') this.takeChapter(chapterNum);
        else if (chapter.status==='taken') this.showChapterText(chapterNum);
        else alert('×¤×¨×§ ×–×” ×›×‘×¨ ×”×•×©×œ×');
      }

      takeChapter(chapterNum){
        const name = document.getElementById('participantName').value.trim();
        const email = document.getElementById('participantEmail').value.trim();
        if (!name){ alert('× × ×œ×”×–×™×Ÿ ×©×'); return; }
        if (!email){ alert('× × ×œ×”×–×™×Ÿ ×“×•××´×œ'); return; }
        const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)){ alert('×“×•××´×œ ×œ× ×ª×§×™×Ÿ'); return; }

        const campaigns = this.getCampaigns();
        const c = campaigns[this.currentCampaignId];
        const ch = c.chapters[chapterNum];

        ch.status='taken'; ch.takenBy=name; ch.takenByEmail=email;
        this.saveCampaigns(campaigns);

        this.sendChapterTakenEmail(c, chapterNum, name, email);
        this.displayChapters(c.chapters);
        this.updateProgress(c.chapters);

        alert(`×¤×¨×§ ${toHebNum(chapterNum)} × ×œ×§×— ×‘×”×¦×œ×—×”! ×”×˜×§×¡×˜ ×™×™×©×œ×— ×œ×“×•××´×œ.`);
        document.getElementById('participantName').value='';
        document.getElementById('participantEmail').value='';
      }

      showChapterText(chapterNum){
        this.currentChapterNum = chapterNum;
        document.getElementById('chapterTitle').textContent = `×ª×”×™×œ×™× â€” ×¤×¨×§ ${toHebNum(chapterNum)}`;
        document.getElementById('chapterContent').textContent = this.tehillimTexts[chapterNum] || '';
        document.getElementById('chapterModal').classList.add('on');
        document.getElementById('completeChapterBtn').onclick = ()=> this.completeChapter(chapterNum);
      }

      completeChapter(chapterNum){
        const campaigns = this.getCampaigns();
        const c = campaigns[this.currentCampaignId];
        const ch = c.chapters[chapterNum];
        if (ch.status!=='taken'){ alert('×œ× × ×™×ª×Ÿ ×œ×¡××Ÿ ×¤×¨×§ ×©×œ× × ×œ×§×—'); return; }
        if (!confirm(`×”×× ×¡×™×™××ª ×œ×§×¨×•× ×¤×¨×§ ${toHebNum(chapterNum)}?`)) return;

        ch.status='completed'; ch.completedAt = new Date().toISOString();
        this.saveCampaigns(campaigns);

        this.sendChapterCompletedEmail(c, chapterNum, ch.takenBy);
        this.displayChapters(c.chapters);
        this.updateProgress(c.chapters);
        this.closeChapterModal();
        alert('×ª×•×“×”! ×”×¤×¨×§ ×¡×•××Ÿ ×›××•×©×œ×.');
      }

      closeChapterModal(){ document.getElementById('chapterModal').classList.remove('on'); }

      async sendCampaignCreatedEmail(campaign){
        if (typeof emailjs==='undefined') return;
        if (!this.emailConfig?.campaignCreatedTemplateId) return;
        const url = `${location.origin}${location.pathname}?campaign=${campaign.id}`;
        const params = {
          to_email: campaign.organizerEmail,
          to_name: campaign.organizer,
          from_name: '×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™×',
          campaign_name: campaign.name,
          campaign_url: url,
          message: `×”×§××¤×™×™×Ÿ "${campaign.name}" × ×•×¦×¨ ×‘×”×¦×œ×—×”! ×©×ª×£ ××ª ×”×§×™×©×•×¨ ×¢× ××—×¨×™×.`,
          subject: `×§××¤×™×™×Ÿ ×ª×”×™×œ×™× × ×•×¦×¨ â€” ${campaign.name}`
        };
        try{ await emailjs.send(this.emailConfig.serviceId, this.emailConfig.campaignCreatedTemplateId, params); }catch(_){}
      }

      async sendChapterTakenEmail(campaign, chapterNum, userName, userEmail){
        if (typeof emailjs==='undefined' || !this.emailConfig) return;

        if (this.emailConfig.chapterCompletedTemplateId){
          const orgParams = {
            to_email: campaign.organizerEmail,
            to_name: campaign.organizer,
            from_name: '×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™×',
            campaign_name: campaign.name,
            chapter_number: toHebNum(chapterNum, false),
            participant_name: userName,
            participant_email: userEmail,
            message: `${userName} ×œ×§×— ×¢×œ ×¢×¦××• ×œ×§×¨×•× ×¤×¨×§ ${toHebNum(chapterNum)} ×‘×§××¤×™×™×Ÿ "${campaign.name}"`,
            subject: `×¤×¨×§ × ×œ×§×— â€” ${campaign.name}`
          };
          try{ await emailjs.send(this.emailConfig.serviceId, this.emailConfig.chapterCompletedTemplateId, orgParams); }catch(_){}
        }

        if (userEmail && this.emailConfig.chapterTakenTemplateId){
          const userParams = {
            to_email: userEmail,
            to_name: userName,
            from_name: '×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™×',
            campaign_name: campaign.name,
            chapter_number: toHebNum(chapterNum, false),
            chapter_text: this.tehillimTexts[chapterNum],
            campaign_url: `${location.origin}${location.pathname}?campaign=${campaign.id}`,
            message: `×§×™×‘×œ×ª ××ª ×¤×¨×§ ${toHebNum(chapterNum)} ××ª×”×™×œ×™× ×¢×‘×•×¨ "${campaign.name}". ×œ××—×¨ ×”×§×¨×™××”, ×—×–×•×¨ ×œ××ª×¨ ×•×¡××Ÿ ×”×©×œ××”.`,
            subject: `×¤×¨×§ ${toHebNum(chapterNum)} â€” ${campaign.name}`
          };
          try{ await emailjs.send(this.emailConfig.serviceId, this.emailConfig.chapterTakenTemplateId, userParams); }catch(_){}
        }
      }

      async sendChapterCompletedEmail(campaign, chapterNum, userName){
        if (typeof emailjs==='undefined' || !this.emailConfig?.chapterCompletedTemplateId) return;
        const params = {
          to_name: campaign.organizer,
          to_email: campaign.organizerEmail,
          campaign_name: campaign.name,
          chapter_number: toHebNum(chapterNum, false),
          user_name: userName,
          message: `${userName} ×¡×™×™× ×œ×§×¨×•× ×¤×¨×§ ${toHebNum(chapterNum)} ×‘×§××¤×™×™×Ÿ "${campaign.name}"!`,
          subject: `×¤×¨×§ ×”×•×©×œ× â€” ${campaign.name}`
        };
        try{ await emailjs.send(this.emailConfig.serviceId, this.emailConfig.chapterCompletedTemplateId, params); }catch(_){}
      }

      generateId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2); }

      initializeChapters(){
        const obj = {};
        for (let i=1;i<=150;i++){
          obj[i] = { status:'available', takenBy:null, takenByEmail:null, completedAt:null };
        }
        return obj;
      }

      showCreateForm(){
        document.getElementById('campaignSection').style.display='none';
        document.getElementById('urlSection').style.display='none';
        history.pushState({}, document.title, location.pathname);
        window.scrollTo({top:0, behavior:'smooth'});
      }

      getTehillimTexts(){
        const t = {};
        for (let i=1;i<=150;i++) t[i] = `××–××•×¨ ${toHebNum(i)}\n(×™×˜×¢×Ÿ ××”Ö¾TXT)`;
        return t;
      }

      displayExistingCampaigns(){
        const box = document.getElementById('campaignsList');
        const campaigns = this.getCampaigns();
        const ids = Object.keys(campaigns);
        box.innerHTML = '';
        if (!ids.length){
          box.innerHTML = '<div class="muted">××™×Ÿ ×§××¤×™×™× ×™× ×§×™×™××™×</div>';
          return;
        }
        ids.forEach(id=>{
          const c = campaigns[id];
          const completed = Object.values(c.chapters).filter(x=>x.status==='completed').length;
          const pct = Math.round(completed/150*100);
          const el = document.createElement('div');
          el.className = 'camp-item';
          el.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
              <div style="font-weight:700">${c.name || '×œ×œ× ×©×'}</div>
              <div class="caption">${pct}% ×”×•×©×œ×</div>
            </div>
            <div class="caption">×××¨×’×Ÿ: ${c.organizer || '×œ× ×™×“×•×¢'} â€¢ ${completed}/150</div>
          `;
          el.onclick = ()=> this.loadCampaign(id);
          box.appendChild(el);
        });
      }
    }

    /* Global helpers */
    function saveEmailConfig(){
      const config = {
        userId: document.getElementById('emailjsUserId').value.trim(),
        serviceId: document.getElementById('emailjsServiceId').value.trim(),
        campaignCreatedTemplateId: document.getElementById('campaignCreatedTemplateId').value.trim(),
        chapterTakenTemplateId: document.getElementById('chapterTakenTemplateId').value.trim(),
        chapterCompletedTemplateId: document.getElementById('chapterCompletedTemplateId').value.trim()
      };
      if (!config.userId || !config.serviceId || !config.campaignCreatedTemplateId || !config.chapterTakenTemplateId || !config.chapterCompletedTemplateId){
        alert('× × ×œ××œ× ××ª ×›×œ ×©×“×•×ª ×”×”×’×“×¨×•×ª'); return;
      }
      localStorage.setItem('tehillimEmailConfig', JSON.stringify(config));
      window.tehillimPlatform.emailConfig = config;
      window.tehillimPlatform.initEmailJS();
      alert('×”×”×’×“×¨×•×ª × ×©××¨×•');
    }

    async function testEmailConnection(){
      if (!window.tehillimPlatform.emailConfig){ alert('××™×Ÿ ×”×’×“×¨×•×ª'); return; }
      const to = prompt('×“×•××´×œ ×œ×‘×“×™×§×”:', 'test@example.com');
      if (!to) return;
      const params = {
        to_email: to,
        to_name: 'Test User',
        from_name: '×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™× - Test',
        campaign_name: 'Test',
        campaign_url: location.href,
        message: '×‘×“×™×§×ª EmailJS',
        subject: 'Test Email - Tehillim'
      };
      try{
        await emailjs.send(window.tehillimPlatform.emailConfig.serviceId, window.tehillimPlatform.emailConfig.campaignCreatedTemplateId, params);
        alert('× ×©×œ×—! ×‘×“×§×• ××ª ×”×ª×™×‘×”.');
      }catch(e){ alert('×›×©×œ ×‘×©×œ×™×—×”: ' + (e?.text || e?.message || e)); }
    }

    function copyUrl(){
      const url = document.getElementById('campaignUrl').textContent;
      navigator.clipboard.writeText(url).then(()=> alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§'));
    }
    function goToCampaign(){
      const c = window.tehillimPlatform.getCampaigns()[window.tehillimPlatform.currentCampaignId];
      document.getElementById('urlSection').style.display='none';
      window.tehillimPlatform.displayCampaign(c);
      history.pushState({}, document.title, `${location.pathname}?campaign=${window.tehillimPlatform.currentCampaignId}`);
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function shareUrl(){
      const url = `${location.origin}${location.pathname}?campaign=${window.tehillimPlatform.currentCampaignId}`;
      if (navigator.share){ navigator.share({title:'×§××¤×™×™×Ÿ ×ª×”×™×œ×™×', text:'×”×¦×˜×¨×¤×• ×œ×§××¤×™×™×Ÿ ×ª×”×™×œ×™×', url}); }
      else { navigator.clipboard.writeText(url).then(()=> alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§')); }
    }
    function showCreateForm(){ window.tehillimPlatform.showCreateForm(); }
    function closeChapterModal(){ window.tehillimPlatform.closeChapterModal(); }

    /* Bootstrap */
    window.tehillimPlatform = new TehillimPlatform();
  </script>

  <!-- ğŸ”„ TXT loader: parses your file and numbers ×¤×¡×•×§×™× with Hebrew letters -->
  <script>
    (async () => {
      const txtUrl = "https://raw.githubusercontent.com/nuchisushi15/tehillim/refs/heads/main/Psalms%20-%20he%20-%20Tanach%20with%20Nikkud%20(1).txt";

      const CH_RE = /^(?:×ª×”×™×œ×™×\s*)?×¤×¨×§\s+([\u0590-\u05FF×´×³"]+)\s*$/;
      const MZ_RE = /^××–××•×¨\s+([\u0590-\u05FF×´×³"]+)\s*$/;
      const V_ARABIC = /^\s*\(?\d{1,3}\)?[.:)\-\s]+/;
      const V_HEB_PARENS = /^\s*\([\u0590-\u05FF×´×³"]{1,4}\)\s+/;
      const V_HEB_BARE = /^\s*[\u0590-\u05FF]{1,4}[×´×³']?\s+/;
      const SOF_PASUQ = /×ƒ/;

      function numberVersesHeb(arr) {
        if (!Array.isArray(arr)) return String(arr || "").trim();
        return arr.map((v, i) => `(${toHebNum(i + 1)}) ${String(v || "").trim()}`).join("\n");
      }

      function parseTehillimTXT(raw) {
        let text = raw.replace(/^\uFEFF/, "");
        text = text.replace(/\r\n?/g, "\n");

        const lines = text.split("\n");
        const chapters = [];
        let current = [];

        for (const line of lines) {
          const l = line.trim();
          if (!l) continue;
          if (CH_RE.test(l) || MZ_RE.test(l)) {
            if (current.length) chapters.push(current);
            current = [];
            continue;
          }
          current.push(line);
        }
        if (current.length) chapters.push(current);

        if (chapters.length === 0) {
          const nonEmpty = lines.filter(l => l.trim());
          const per = Math.max(1, Math.floor(nonEmpty.length / 150));
          for (let i = 0; i < 150; i++) {
            chapters.push(nonEmpty.slice(i * per, (i + 1) * per));
          }
        }

        function splitChapterToVerses(chLines) {
          const verses = [];
          let cur = "";
          let sawMarkers = false;

          const push = () => {
            const t = cur.trim();
            if (t) verses.push(t);
            cur = "";
          };

          for (let rawLine of chLines) {
            let line = rawLine.trim();
            if (!line) continue;

            let stripped = line;
            if (V_ARABIC.test(stripped)) {
              stripped = stripped.replace(V_ARABIC, "");
              sawMarkers = true;
              push();
              cur = stripped;
              continue;
            }
            if (V_HEB_PARENS.test(stripped)) {
              stripped = stripped.replace(V_HEB_PARENS, "");
              sawMarkers = true;
              push();
              cur = stripped;
              continue;
            }
            if (V_HEB_BARE.test(stripped)) {
              const tmp = stripped.replace(V_HEB_BARE, "");
              if (tmp.length >= 3) {
                stripped = tmp;
                sawMarkers = true;
                push();
                cur = stripped;
                continue;
              }
            }

            if (cur) cur += " " + line;
            else cur = line;

            if (SOF_PASUQ.test(line)) {
              push();
            }
          }
          push();

          if (!sawMarkers && verses.length <= 2) {
            const fallback = chLines.map(l => l.trim()).filter(Boolean);
            if (fallback.length) return fallback;
          }
          return verses;
        }

        const mapped = {};
        let idx = 1;
        for (const block of chapters) {
          if (idx > 150) break;
          const verses = splitChapterToVerses(block);
          mapped[idx] = numberVersesHeb(verses);
          idx++;
        }
        return mapped;
      }

      try {
        const res = await fetch(txtUrl);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const raw = await res.text();

        const texts = parseTehillimTXT(raw);
        const count = Object.keys(texts).length;

        if (count >= 150) {
          window.tehillimPlatform.tehillimTexts = texts;

          if (window.tehillimPlatform.currentChapterNum) {
            const n = window.tehillimPlatform.currentChapterNum;
            document.getElementById("chapterContent").textContent =
              window.tehillimPlatform.tehillimTexts[n] || "";
          }
          console.log("âœ… Loaded Tehillim from TXT with Hebrew-letter ×¤×¡×•×§×™×. Chapters:", count);
        } else {
          console.warn("âš ï¸ Only parsed", count, "chapters (expected 150). Check TXT format.");
        }
      } catch (err) {
        console.error("Failed to load TXT:", err);
      }
    })();
  </script>
</body>
</html>
