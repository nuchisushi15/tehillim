<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>פלטפורמת תהילים — עיצוב חדש</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --brand:#6d28d9;          /* deep purple */
      --brand-2:#7c3aed;        /* lighter purple */
      --accent:#10b981;         /* teal/green */
      --danger:#ef4444;
      --ring:rgba(109,40,217,.18);
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Hebrew", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      background: radial-gradient(1000px 600px at 80% -200px, #ede9fe 0%, transparent 70%), var(--bg);
      color:var(--ink);
    }

    /* Layout */
    .shell{
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height:100vh;
    }
    @media (max-width: 960px){
      .shell{grid-template-columns: 1fr}
      .sidebar{position:static; height:auto}
    }

    header.topbar{
      grid-column: 1 / -1;
      position: sticky;
      top:0;
      z-index: 5;
      background: rgba(255,255,255,.7);
      backdrop-filter: saturate(180%) blur(12px);
      border-bottom: 1px solid #e5e7eb;
    }
    .topbar-inner{
      max-width: 1200px;
      margin:0 auto;
      padding:14px 20px;
      display:flex;
      align-items:center;
      gap:16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:800;
      color:var(--brand);
      letter-spacing:.2px;
    }
    .brand .logo{
      width:36px; height:36px; border-radius:10px;
      background: conic-gradient(from 220deg, var(--brand), var(--brand-2));
      box-shadow: 0 8px 18px var(--ring);
    }
    .top-actions{margin-inline-start:auto; display:flex; gap:8px}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer;
      background:var(--brand); color:white;
      box-shadow: 0 6px 16px var(--ring);
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.secondary{background:#111827; color:#fff; box-shadow:none}
    .btn.ghost{background:transparent; color:var(--brand); box-shadow:none}
    .btn.success{background:var(--accent)}
    .btn.danger{background:var(--danger)}

    /* Sidebar */
    .sidebar{
      position: sticky; top:60px; align-self:start;
      height: calc(100vh - 60px);
      padding:20px;
      border-inline-end:1px solid #e5e7eb;
      background:linear-gradient(180deg, rgba(124,58,237,.06), transparent 180px);
    }
    .card{
      background:var(--card); border:1px solid #eef0f6; border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .panel{padding:18px}
    .panel h3{margin:0 0 8px; font-size:18px}
    .muted{color:var(--muted)}
    .hr{height:1px; background:#eef0f6; margin:12px 0}

    .form{display:grid; gap:12px}
    .row{display:grid; gap:6px}
    label{font-size:13px; color:#374151; font-weight:600}
    input, textarea, select{
      background:#fff; border:1.5px solid #e5e7eb; border-radius:12px; padding:12px 14px; font:inherit;
      outline:none; transition: border .15s, box-shadow .15s;
    }
    textarea{min-height:84px; resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:var(--brand); box-shadow: 0 0 0 4px var(--ring)}
    .helper{font-size:12px; color:var(--muted)}

    .campaigns{
      margin-top:16px; display:flex; flex-direction:column; gap:10px; max-height:40vh; overflow:auto;
    }
    .camp-item{
      padding:12px; border-radius:14px; border:1px solid #e5e7eb; background:#fff; cursor:pointer;
      display:flex; flex-direction:column; gap:6px; transition: background .15s, transform .06s;
    }
    .camp-item:hover{background:#fafafa; transform: translateY(-1px)}
    .caption{font-size:12px; color:var(--muted)}

    /* Main */
    .main{
      padding:24px; max-width: 1000px; width:100%;
    }
    .hero{
      display:flex; flex-direction:column; gap:10px; margin-bottom:18px;
    }
    .hero h2{margin:0}
    .info-banner{
      padding:14px; border-radius:14px; background:#f0fdfa; border:1px solid #ccfbf1; color:#065f46;
    }

    .grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(54px, 1fr)); gap:10px;
    }
    .chip{
      user-select:none;
      text-align:center; padding:12px 6px; border-radius:14px; border:1.5px solid #e5e7eb; background:#fff;
      font-weight:800; letter-spacing:.3px;
      transition: transform .06s, border .15s, background .15s, color .15s;
      cursor:pointer;
    }
    .chip:hover{transform: translateY(-1px); border-color:var(--brand)}
    .chip.taken{background:#eef2ff; border-color:#c7d2fe; color:#4338ca}
    .chip.completed{background:#e5efe7; border-color:#a7f3d0; color:#065f46}

    .progress{
      display:flex; align-items:center; gap:14px; margin:14px 0 8px;
    }
    .bar{flex:1; height:14px; background:#eef0f6; border-radius:999px; overflow:hidden}
    .fill{height:100%; width:0; background:linear-gradient(90deg, var(--accent), #34d399); transition: width .45s ease}

    .section{margin-top:18px}
    .stack{display:grid; gap:12px}

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.on{ display:flex }
    .backdrop{ position:absolute; inset:0; background:rgba(17,24,39,.55); backdrop-filter: blur(4px); }
    .dialog{ position:relative; width:min(720px, 92vw); max-height:85vh; overflow:auto; background:var(--card); border-radius:20px; box-shadow: 0 20px 60px rgba(17,24,39,.35); }
    .dialog header{ position:sticky; top:0; background:#fff; padding:16px; border-bottom:1px solid #eef0f6; border-radius:20px 20px 0 0}
    .dialog .content{ padding:18px; white-space:pre-wrap; line-height:2; font-size:18px }
    .close-x{ position:absolute; left:14px; top:12px; background:transparent; border:0; font-size:22px; cursor:pointer }

    .pill{
      display:inline-flex; gap:8px; align-items:center; font-size:12px;
      padding:6px 10px; border-radius:999px; background:#f5f3ff; color:#4c1d95; border:1px solid #ddd6fe;
    }

    .urlbox{padding:10px 12px; background:#f9fafb; border:1px dashed var(--brand); border-radius:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; direction:ltr}

    .subtle{color:#4b5563; font-size:13px}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand"><div class="logo"></div> פלטפורמת תהילים</div>
      <div class="top-actions">
        <button class="btn ghost" onclick="scrollTo({top:0,behavior:'smooth'})">למעלה</button>
        <button class="btn success" onclick="showCreateForm()">קמפיין חדש</button>
      </div>
    </div>
  </header>

  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="card panel">
        <h3>יצירת קמפיין</h3>
        <p class="muted">בחר שם, הזן פרטי מארגן, וקבל קישור לשיתוף.</p>
        <div class="hr"></div>
        <form id="campaignForm" class="form">
          <div class="row">
            <label for="campaignName">שם הקמפיין</label>
            <input id="campaignName" type="text" placeholder="לרפואת... / לע״נ... / לזכות..." required />
          </div>
          <div class="row">
            <label for="campaignDescription">תיאור (אופציונלי)</label>
            <textarea id="campaignDescription" placeholder="פרטים נוספים על הקמפיין..."></textarea>
          </div>
          <div class="row">
            <label for="organizerName">שם המארגן</label>
            <input id="organizerName" type="text" required />
          </div>
          <div class="row">
            <label for="organizerEmail">מייל המארגן</label>
            <input id="organizerEmail" type="email" placeholder="name@email.com" required />
            <div class="helper">ישלח לשם קישור לניהול הקמפיין</div>
          </div>
          <button class="btn" type="submit">צור קמפיין</button>
        </form>
      </div>

      <div class="card panel" style="margin-top:14px">
        <h3>קמפיינים קיימים</h3>
        <div id="campaignsList" class="campaigns">
          <div class="muted">אין קמפיינים קיימים</div>
        </div>
      </div>

      <div class="card panel" style="margin-top:14px">
        <h3>הגדרת דוא״ל</h3>
        <p class="subtle">EmailJS נדרש לשליחת התראות וטקסט הפרק.</p>
        <div class="hr"></div>
        <div class="stack">
          <div class="row">
            <label for="emailjsUserId">Public Key</label>
            <input id="emailjsUserId" type="text" value="d_LsqV-KBZuAeuCjf">
          </div>
          <div class="row">
            <label for="emailjsServiceId">Service ID</label>
            <input id="emailjsServiceId" type="text" value="service_p76h23d">
          </div>
          <div class="row">
            <label for="campaignCreatedTemplateId">תבנית: יצירת קמפיין</label>
            <input id="campaignCreatedTemplateId" type="text" value="template_0hmmrlk">
          </div>
          <div class="row">
            <label for="chapterTakenTemplateId">תבנית: נטילת פרק</label>
            <input id="chapterTakenTemplateId" type="text" value="template_swui2zf">
          </div>
          <div class="row">
            <label for="chapterCompletedTemplateId">תבנית: השלמת פרק</label>
            <input id="chapterCompletedTemplateId" type="text" value="template_j01dkdf">
          </div>
          <div style="display:flex; gap:8px">
            <button class="btn" onclick="saveEmailConfig()">שמור</button>
            <button class="btn ghost" onclick="testEmailConnection()">בדיקת שליחה</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="hero">
        <h2>קמפיין תהילים</h2>
        <div class="info-banner">
          <b>איך זה עובד?</b> יוצרים קמפיין, משתפים את הקישור, כל משתתף לוקח פרק (מסומן באותיות א-ת),
          מקבל את הטקסט במייל ומסמן השלמה בסיום.
        </div>
      </div>

      <!-- Share URL -->
      <section id="urlSection" class="card panel" style="display:none">
        <h3>קמפיין נוצר בהצלחה</h3>
        <p class="muted">שתפו את הקישור כדי לצרף משתתפים.</p>
        <div class="urlbox" id="campaignUrl"></div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button class="btn secondary" onclick="copyUrl()">העתק קישור</button>
          <button class="btn" onclick="goToCampaign()">מעבר לקמפיין</button>
        </div>
      </section>

      <!-- Campaign View -->
      <section id="campaignSection" class="card panel" style="display:none">
        <div id="campaignInfo" class="stack"></div>

        <div class="card panel" style="background:#faf5ff; border-color:#e9d5ff; margin-top:10px">
          <h3>לפני נטילת פרק</h3>
          <div class="stack">
            <div class="row">
              <label for="participantName">שמך</label>
              <input id="participantName" type="text" placeholder="שם מלא">
            </div>
            <div class="row">
              <label for="participantEmail">דוא״ל</label>
              <input id="participantEmail" type="email" placeholder="name@email.com">
            </div>
            <div class="pill">לאחר מילוי הפרטים, לחץ על אות פרק לבחירה</div>
          </div>
        </div>

        <div class="progress">
          <div id="progressText" class="muted"></div>
          <div class="bar"><div id="progressFill" class="fill"></div></div>
        </div>

        <div class="section">
          <h3>בחרו פרקי תהילים</h3>
          <p class="subtle">לחיצה על האות לוקחת את הפרק על אחריותכם. תקבלו את הטקסט המלא בדוא״ל.</p>
          <div id="chaptersGrid" class="grid" style="margin-top:10px"></div>
        </div>

        <div style="display:flex; gap:8px; margin-top:14px">
          <button class="btn secondary" onclick="shareUrl()">שיתוף קמפיין</button>
          <button class="btn ghost" onclick="showCreateForm()">קמפיין חדש</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div id="chapterModal" class="modal" role="dialog" aria-modal="true">
    <div class="backdrop" onclick="closeChapterModal()"></div>
    <div class="dialog">
      <header>
        <button class="close-x" onclick="closeChapterModal()" aria-label="סגור">×</button>
        <h3 id="chapterTitle" style="margin:0"></h3>
      </header>
      <div id="chapterContent" class="content"></div>
      <div style="display:flex; gap:8px; padding:0 18px 18px 18px">
        <button class="btn success" id="completeChapterBtn">סיימתי לקרוא — סמן כמושלם</button>
        <button class="btn ghost" onclick="closeChapterModal()">סגור</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Hebrew numerals ---------- */
    const H_UNITS = {1:'א',2:'ב',3:'ג',4:'ד',5:'ה',6:'ו',7:'ז',8:'ח',9:'ט'};
    const H_TENS = {10:'י',20:'כ',30:'ל',40:'מ',50:'נ',60:'ס',70:'ע',80:'פ',90:'צ'};
    const H_HUND = {100:'ק',200:'ר',300:'ש',400:'ת'};
    function toHebNum(n, punctuation=true){
      // Build additive Hebrew numerals: 1..999+
      let result = '';
      let num = n;

      // hundreds (400, 300, 200, 100 ...)
      [400,300,200,100].forEach(h=>{
        while(num>=h){ result += H_HUND[h]; num -= h; }
      });

      // tens special cases (15, 16 as ט״ו, ט״ז)
      if (num === 15){ result += 'טו'; num = 0; }
      else if (num === 16){ result += 'טז'; num = 0; }
      else{
        [90,80,70,60,50,40,30,20,10].forEach(t=>{
          while(num>=t){ result += H_TENS[t]; num -= t; }
        });
      }

      // units
      if (num>0) result += H_UNITS[num] || '';

      // gershayim/geresh (optional visual punctuation)
      if (!punctuation) return result;
      if (result.length >= 2){
        // add ״ before last char
        return result.slice(0,-1) + '״' + result.slice(-1);
      }else if (result.length === 1){
        return result + '׳';
      }
      return result;
    }

    /* ---------- Platform ---------- */
    class TehillimPlatform {
      constructor(){
        this.currentCampaignId = null;
        this.currentChapterNum = null;
        this.emailConfig = null;
        this.tehillimTexts = this.getTehillimTexts(); // placeholder until JSON loads
        this.init();
      }

      init(){
        this.loadEmailConfig();
        if (typeof emailjs !== 'undefined') this.initEmailJS();

        this.setupEventListeners();
        this.loadFromUrl();
        this.displayExistingCampaigns();
      }

      setupEventListeners(){
        document.getElementById('campaignForm').addEventListener('submit', (e)=>{
          e.preventDefault();
          this.createCampaign();
        });
        // Modal close with ESC
        window.addEventListener('keydown', (e)=>{ if (e.key==='Escape') this.closeChapterModal(); });
      }

      /* -------- Email config -------- */
      loadEmailConfig(){
        const defaultConfig = {
          userId: 'd_LsqV-KBZuAeuCjf',
          serviceId: 'service_p76h23d',
          campaignCreatedTemplateId: 'template_0hmmrlk',
          chapterTakenTemplateId: 'template_swui2zf',
          chapterCompletedTemplateId: 'template_j01dkdf'
        };
        const saved = localStorage.getItem('tehillimEmailConfig');
        if (saved){
          const parsed = JSON.parse(saved);
          this.emailConfig = {
            ...defaultConfig,
            ...parsed
          };
        } else {
          this.emailConfig = defaultConfig;
          localStorage.setItem('tehillimEmailConfig', JSON.stringify(defaultConfig));
        }
      }

      initEmailJS(){
        try{
          emailjs.init(this.emailConfig.userId);
        }catch(_){
          try{ emailjs.init({ publicKey: this.emailConfig.userId }); } catch(e){ console.error(e); }
        }
      }

      /* -------- Routing -------- */
      loadFromUrl(){
        const urlParams = new URLSearchParams(location.search);
        const campaignId = urlParams.get('campaign');
        if (campaignId) this.loadCampaign(campaignId);
      }

      /* -------- Campaigns -------- */
      getCampaigns(){
        const data = localStorage.getItem('tehillimCampaigns');
        return data ? JSON.parse(data) : {};
      }
      saveCampaigns(c){
        localStorage.setItem('tehillimCampaigns', JSON.stringify(c));
      }

      createCampaign(){
        const name = document.getElementById('campaignName').value.trim();
        const description = document.getElementById('campaignDescription').value.trim();
        const organizer = document.getElementById('organizerName').value.trim();
        const organizerEmail = document.getElementById('organizerEmail').value.trim();
        if (!name || !organizer || !organizerEmail){
          alert('נא למלא את כל השדות הנדרשים'); return;
        }

        const id = this.generateId();
        const campaign = {
          id, name, description, organizer, organizerEmail,
          created: new Date().toISOString(),
          chapters: this.initializeChapters()
        };
        const campaigns = this.getCampaigns();
        campaigns[id] = campaign;
        this.saveCampaigns(campaigns);

        this.sendCampaignCreatedEmail(campaign);
        this.showCampaignUrl(id);
        (document.getElementById('campaignForm')).reset();
        this.displayExistingCampaigns();
      }

      showCampaignUrl(id){
        const base = location.origin + location.pathname;
        const url = `${base}?campaign=${id}`;
        document.getElementById('campaignUrl').textContent = url;
        document.getElementById('urlSection').style.display = '';
      }

      loadCampaign(id){
        const campaigns = this.getCampaigns();
        const c = campaigns[id];
        if (!c){ alert('קמפיין לא נמצא'); return; }
        this.currentCampaignId = id;
        this.displayCampaign(c);
      }

      displayCampaign(campaign){
        document.getElementById('urlSection').style.display = 'none';
        document.getElementById('campaignSection').style.display = '';

        const info = document.getElementById('campaignInfo');
        info.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <h3 style="margin:0">${campaign.name}</h3>
            <span class="pill">נוצר: ${new Date(campaign.created).toLocaleDateString('he-IL')}</span>
          </div>
          ${campaign.description ? `<div class="muted">${campaign.description}</div>` : ''}
          <div class="subtle">מארגן: <b>${campaign.organizer}</b></div>
        `;

        this.displayChapters(campaign.chapters);
        this.updateProgress(campaign.chapters);
      }

      displayChapters(chapters){
        const grid = document.getElementById('chaptersGrid');
        grid.innerHTML = '';
        for (let i=1;i<=150;i++){
          const ch = chapters[i];
          const div = document.createElement('div');
          const state = ch.status; // available | taken | completed
          div.className = `chip ${state}`;
          div.textContent = toHebNum(i); // Hebrew chapter label
          if (state==='taken') div.title = `נלקח על ידי: ${ch.takenBy || 'אלמוני'}`;
          if (state==='completed') div.title = `הושלם על ידי: ${ch.takenBy || 'אלמוני'}`;
          div.onclick = ()=> this.handleChapterClick(i);
          grid.appendChild(div);
        }
      }

      updateProgress(chapters){
        const total = 150;
        const taken = Object.values(chapters).filter(ch => ch.status!=='available').length;
        const available = total - taken;
        const pct = Math.round((taken/total)*100);
        document.getElementById('progressText').textContent = `נלקחו: ${toHebNum(taken, false)} | זמינים: ${toHebNum(available, false)} | סה״כ: ${toHebNum(total, false)} (${pct}%)`;
        document.getElementById('progressFill').style.width = `${pct}%`;
      }

      handleChapterClick(chNum){
        const campaigns = this.getCampaigns();
        const c = campaigns[this.currentCampaignId];
        const chapter = c.chapters[chNum];

        if (chapter.status==='available') this.takeChapter(chNum);
        else if (chapter.status==='taken') this.showChapterText(chNum);
        else alert('פרק זה כבר הושלם');
      }

      takeChapter(chapterNum){
        const name = document.getElementById('participantName').value.trim();
        const email = document.getElementById('participantEmail').value.trim();
        if (!name){ alert('נא להזין שם'); return; }
        if (!email){ alert('נא להזין דוא״ל'); return; }
        const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)){ alert('דוא״ל לא תקין'); return; }

        const campaigns = this.getCampaigns();
        const c = campaigns[this.currentCampaignId];
        const ch = c.chapters[chapterNum];

        ch.status='taken'; ch.takenBy=name; ch.takenByEmail=email;
        this.saveCampaigns(campaigns);

        this.sendChapterTakenEmail(c, chapterNum, name, email);
        this.displayChapters(c.chapters);
        this.updateProgress(c.chapters);

        alert(`פרק ${toHebNum(chapterNum)} נלקח בהצלחה! הטקסט יישלח לדוא״ל.`);
        document.getElementById('participantName').value='';
        document.getElementById('participantEmail').value='';
      }

      showChapterText(chapterNum){
        this.currentChapterNum = chapterNum;
        document.getElementById('chapterTitle').textContent = `תהילים — פרק ${toHebNum(chapterNum)}`;
        document.getElementById('chapterContent').textContent = this.tehillimTexts[chapterNum] || '';
        document.getElementById('chapterModal').classList.add('on');
        document.getElementById('completeChapterBtn').onclick = ()=> this.completeChapter(chapterNum);
      }

      completeChapter(chapterNum){
        const campaigns = this.getCampaigns();
        const c = campaigns[this.currentCampaignId];
        const ch = c.chapters[chapterNum];
        if (ch.status!=='taken'){ alert('לא ניתן לסמן פרק שלא נלקח'); return; }
        if (!confirm(`האם סיימת לקרוא פרק ${toHebNum(chapterNum)}?`)) return;

        ch.status='completed'; ch.completedAt = new Date().toISOString();
        this.saveCampaigns(campaigns);

        this.sendChapterCompletedEmail(c, chapterNum, ch.takenBy);
        this.displayChapters(c.chapters);
        this.updateProgress(c.chapters);
        this.closeChapterModal();
        alert('תודה! הפרק סומן כמושלם.');
      }

      closeChapterModal(){ document.getElementById('chapterModal').classList.remove('on'); }

      /* -------- Email -------- */
      async sendCampaignCreatedEmail(campaign){
        if (typeof emailjs==='undefined') return;
        if (!this.emailConfig?.campaignCreatedTemplateId) return;

        const url = `${location.origin}${location.pathname}?campaign=${campaign.id}`;
        const params = {
          to_email: campaign.organizerEmail,
          to_name: campaign.organizer,
          from_name: 'פלטפורמת תהילים',
          campaign_name: campaign.name,
          campaign_url: url,
          message: `הקמפיין "${campaign.name}" נוצר בהצלחה! שתף את הקישור עם אחרים.`,
          subject: `קמפיין תהילים נוצר — ${campaign.name}`
        };
        try{
          await emailjs.send(this.emailConfig.serviceId, this.emailConfig.campaignCreatedTemplateId, params);
        }catch(e){ console.warn('sendCampaignCreatedEmail failed', e); }
      }

      async sendChapterTakenEmail(campaign, chapterNum, userName, userEmail){
        if (typeof emailjs==='undefined' || !this.emailConfig) return;

        // notify organizer
        if (this.emailConfig.chapterCompletedTemplateId){
          const orgParams = {
            to_email: campaign.organizerEmail,
            to_name: campaign.organizer,
            from_name: 'פלטפורמת תהילים',
            campaign_name: campaign.name,
            chapter_number: toHebNum(chapterNum, false),
            participant_name: userName,
            participant_email: userEmail,
            message: `${userName} לקח על עצמו לקרוא פרק ${toHebNum(chapterNum)} בקמפיין "${campaign.name}"`,
            subject: `פרק נלקח — ${campaign.name}`
          };
          try{ await emailjs.send(this.emailConfig.serviceId, this.emailConfig.chapterCompletedTemplateId, orgParams); }catch(_){}
        }

        // send text to participant
        if (userEmail && this.emailConfig.chapterTakenTemplateId){
          const userParams = {
            to_email: userEmail,
            to_name: userName,
            from_name: 'פלטפורמת תהילים',
            campaign_name: campaign.name,
            chapter_number: toHebNum(chapterNum, false),
            chapter_text: this.tehillimTexts[chapterNum],
            campaign_url: `${location.origin}${location.pathname}?campaign=${campaign.id}`,
            message: `קיבלת את פרק ${toHebNum(chapterNum)} מתהילים עבור "${campaign.name}". לאחר הקריאה, חזור לאתר וסמן השלמה.`,
            subject: `פרק ${toHebNum(chapterNum)} — ${campaign.name}`
          };
          try{ await emailjs.send(this.emailConfig.serviceId, this.emailConfig.chapterTakenTemplateId, userParams); }catch(_){}
        }
      }

      async sendChapterCompletedEmail(campaign, chapterNum, userName){
        if (typeof emailjs==='undefined' || !this.emailConfig?.chapterCompletedTemplateId) return;
        const params = {
          to_name: campaign.organizer,
          to_email: campaign.organizerEmail,
          campaign_name: campaign.name,
          chapter_number: toHebNum(chapterNum, false),
          user_name: userName,
          message: `${userName} סיים לקרוא פרק ${toHebNum(chapterNum)} בקמפיין "${campaign.name}"!`,
          subject: `פרק הושלם — ${campaign.name}`
        };
        try{
          await emailjs.send(this.emailConfig.serviceId, this.emailConfig.chapterCompletedTemplateId, params);
        }catch(e){ console.warn('sendChapterCompletedEmail failed', e); }
      }

      /* -------- Utils -------- */
      generateId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2); }

      initializeChapters(){
        const obj = {};
        for (let i=1;i<=150;i++){
          obj[i] = { status:'available', takenBy:null, takenByEmail:null, completedAt:null };
        }
        return obj;
      }

      showCreateForm(){
        document.getElementById('campaignSection').style.display='none';
        document.getElementById('urlSection').style.display='none';
        history.pushState({}, document.title, location.pathname);
        window.scrollTo({top:0, behavior:'smooth'});
      }

      getTehillimTexts(){
        // Placeholder until JSON is loaded; will be replaced.
        const t = {};
        for (let i=1;i<=150;i++) t[i] = `מזמור ${toHebNum(i)}\n(יטען מה־JSON)`;
        return t;
      }
    }

    /* ---------- Global helpers bound to UI ---------- */
    function saveEmailConfig(){
      const config = {
        userId: document.getElementById('emailjsUserId').value.trim(),
        serviceId: document.getElementById('emailjsServiceId').value.trim(),
        campaignCreatedTemplateId: document.getElementById('campaignCreatedTemplateId').value.trim(),
        chapterTakenTemplateId: document.getElementById('chapterTakenTemplateId').value.trim(),
        chapterCompletedTemplateId: document.getElementById('chapterCompletedTemplateId').value.trim()
      };
      if (!config.userId || !config.serviceId || !config.campaignCreatedTemplateId || !config.chapterTakenTemplateId || !config.chapterCompletedTemplateId){
        alert('נא למלא את כל שדות ההגדרות'); return;
      }
      localStorage.setItem('tehillimEmailConfig', JSON.stringify(config));
      window.tehillimPlatform.emailConfig = config;
      window.tehillimPlatform.initEmailJS();
      alert('ההגדרות נשמרו');
    }

    async function testEmailConnection(){
      if (!window.tehillimPlatform.emailConfig){ alert('אין הגדרות'); return; }
      const to = prompt('דוא״ל לבדיקה:', 'test@example.com');
      if (!to) return;
      const params = {
        to_email: to,
        to_name: 'Test User',
        from_name: 'פלטפורמת תהילים - Test',
        campaign_name: 'Test',
        campaign_url: location.href,
        message: 'בדיקת EmailJS',
        subject: 'Test Email - Tehillim'
      };
      try{
        await emailjs.send(window.tehillimPlatform.emailConfig.serviceId, window.tehillimPlatform.emailConfig.campaignCreatedTemplateId, params);
        alert('נשלח! בדקו את התיבה.');
      }catch(e){ alert('כשל בשליחה: ' + (e?.text || e?.message || e)); }
    }

    function copyUrl(){
      const url = document.getElementById('campaignUrl').textContent;
      navigator.clipboard.writeText(url).then(()=> alert('הקישור הועתק'));
    }
    function goToCampaign(){
      const c = window.tehillimPlatform.getCampaigns()[window.tehillimPlatform.currentCampaignId];
      document.getElementById('urlSection').style.display='none';
      window.tehillimPlatform.displayCampaign(c);
      history.pushState({}, document.title, `${location.pathname}?campaign=${window.tehillimPlatform.currentCampaignId}`);
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function shareUrl(){
      const url = `${location.origin}${location.pathname}?campaign=${window.tehillimPlatform.currentCampaignId}`;
      if (navigator.share){ navigator.share({title:'קמפיין תהילים', text:'הצטרפו לקמפיין תהילים', url}); }
      else { navigator.clipboard.writeText(url).then(()=> alert('הקישור הועתק')); }
    }
    function showCreateForm(){ window.tehillimPlatform.showCreateForm(); }
    function closeChapterModal(){ window.tehillimPlatform.closeChapterModal(); }

    /* ---------- Bootstrap ---------- */
    window.tehillimPlatform = new TehillimPlatform();

    /* ---------- Load full text JSON & number פסוקים with Hebrew letters ---------- */
    (async ()=>{
      // Replace with your JSON if needed:
      const jsonUrl = "https://raw.githubusercontent.com/nuchisushi15/tehillim/refs/heads/main/Psalms%20-%20he%20-%20Miqra%20according%20to%20the%20Masorah.json";
      try{
        const res = await fetch(jsonUrl);
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        const numberVersesHeb = (arr)=>{
          if (!Array.isArray(arr)) return String(arr||'').trim();
          return arr.map((v,i)=>`(${toHebNum(i+1)}) ${typeof v==='string'? v.trim() : String(v||'').trim()}`).join('\n');
        };

        function parseStructure(src){
          const out = {};
          if (Array.isArray(src?.chapters)){
            src.chapters.forEach((verses, idx)=> out[idx+1] = numberVersesHeb(verses));
            return out;
          }
          if (Array.isArray(src?.text)){
            src.text.forEach((verses, idx)=> out[idx+1] = numberVersesHeb(verses));
            return out;
          }
          const numericKeys = Object.keys(src||{}).filter(k=>/^\d+$/.test(k));
          if (numericKeys.length){
            numericKeys.sort((a,b)=>+a-+b).forEach(k=> out[+k]= numberVersesHeb(src[k]));
            return out;
          }
          const bookNode = src?.Psalms || src?.Tehillim || src?.psalms || src?.tehillim || src?.book || null;
          if (bookNode) return parseStructure(bookNode);
          return out;
        }

        const mapped = parseStructure(data);
        if (Object.keys(mapped).length >= 150){
          window.tehillimPlatform.tehillimTexts = mapped;
          // If a modal is open, refresh with numbered text:
          if (window.tehillimPlatform.currentChapterNum){
            const n = window.tehillimPlatform.currentChapterNum;
            document.getElementById('chapterContent').textContent = window.tehillimPlatform.tehillimTexts[n] || '';
          }
          console.log('✅ Full Tehillim loaded with Hebrew פסוק numbers.');
        }else{
          console.warn('⚠️ לא זוהו כל 150 הפרקים מה־JSON');
        }
      }catch(e){
        console.error('טעינת JSON נכשלה', e);
      }
    })();

    /* ---------- Populate existing campaigns on load ---------- */
    (function initialList(){
      window.tehillimPlatform.displayExistingCampaigns = function(){
        const box = document.getElementById('campaignsList');
        const campaigns = this.getCampaigns();
        const ids = Object.keys(campaigns);
        box.innerHTML = '';
        if (!ids.length){
          box.innerHTML = '<div class="muted">אין קמפיינים קיימים</div>';
          return;
        }
        ids.forEach(id=>{
          const c = campaigns[id];
          const completed = Object.values(c.chapters).filter(x=>x.status==='completed').length;
          const pct = Math.round(completed/150*100);
          const el = document.createElement('div');
          el.className = 'camp-item';
          el.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
              <div style="font-weight:700">${c.name || 'ללא שם'}</div>
              <div class="caption">${pct}% הושלם</div>
            </div>
            <div class="caption">מארגן: ${c.organizer || 'לא ידוע'} • ${completed}/150</div>
          `;
          el.onclick = ()=> this.loadCampaign(id);
          box.appendChild(el);
        });
      };
      window.tehillimPlatform.displayExistingCampaigns();
    })();
  </script>
</body>
</html>
