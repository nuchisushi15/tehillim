<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פלטפורמת תהילים - Tehillim Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .create-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], input[type="email"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            direction: rtl;
        }

        input[type="email"] {
            direction: ltr;
        }

        input[type="text"]:focus, input[type="email"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .url-display {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            direction: ltr;
            text-align: center;
            font-family: monospace;
            font-size: 14px;
        }

        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .chapter-btn {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .chapter-btn:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .chapter-btn.taken {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .chapter-btn.completed {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }

        .campaign-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid #667eea;
        }

        .hidden {
            display: none;
        }

        .campaigns-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .campaign-item {
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .campaign-item:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .chapter-text {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            direction: rtl;
            text-align: right;
            line-height: 2;
            font-size: 18px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            direction: rtl;
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .email-setup {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .chapters-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 8px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .modal-content {
                margin: 2% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>פלטפורמת תהילים</h1>
            <p>יוצרים קמפיינים ומשלימים תהילים יחד</p>
        </div>

        <!-- Email Setup Section -->
        <div id="emailSetup" class="card email-setup">
            <h3>הגדרת שירות מייל</h3>
            <p>כדי לקבל התראות במייל, יש להזין את פרטי EmailJS החדשים:</p>
            <div class="alert alert-warning">
                <strong>שגיאת Public Key!</strong> יש לעדכן את המפתח הציבורי מלוח הבקרה של EmailJS
            </div>
            <div class="form-group">
                <label for="emailjsUserId">EmailJS Public Key:</label>
                <input type="text" id="emailjsUserId" value="d_LsqV-KBZuAeuCjf" placeholder="הכנס את המפתח הציבורי החדש">
            </div>
            <div class="form-group">
                <label for="emailjsServiceId">EmailJS Service ID:</label>
                <input type="text" id="emailjsServiceId" value="service_p76h23d">
            </div>
            <div class="form-group">
                <label for="emailjsTemplateId">EmailJS Template ID:</label>
                <input type="text" id="emailjsTemplateId" value="template_46i4yl5">
            </div>
            <button class="btn" onclick="saveEmailConfig()">שמור הגדרות</button>
            <button class="btn btn-secondary" onclick="hideEmailSetup()">דלג לעת עתה</button>
        </div>

        <!-- Create Campaign Section -->
        <div id="createSection" class="card create-section">
            <h2>יצירת קמפיין חדש</h2>
            <form id="campaignForm">
                <div class="form-group">
                    <label for="campaignName">שם הקמפיין:</label>
                    <input type="text" id="campaignName" required placeholder="לרפואת... / לעילוי נשמת... / לזכות...">
                </div>
                <div class="form-group">
                    <label for="campaignDescription">תיאור (אופציונלי):</label>
                    <textarea id="campaignDescription" placeholder="פרטים נוספים על הקמפיין..."></textarea>
                </div>
                <div class="form-group">
                    <label for="organizerName">שם המארגן:</label>
                    <input type="text" id="organizerName" required placeholder="השם שלך">
                </div>
                <div class="form-group">
                    <label for="organizerEmail">מייל המארגן:</label>
                    <input type="email" id="organizerEmail" required placeholder="your@email.com">
                </div>
                <button type="submit" class="btn">צור קמפיין</button>
            </form>
        </div>

        <!-- Campaign URL Display -->
        <div id="urlSection" class="card hidden">
            <h3>קמפיין נוצר בהצלחה!</h3>
            <div class="alert alert-success">
                שתף את הקישור הזה עם אחרים כדי שיוכלו להצטרף לקמפיין. נשלח מייל עם הקישור לכתובת שהזנת.
            </div>
            <div class="url-display" id="campaignUrl"></div>
            <button class="btn btn-secondary" onclick="copyUrl()">העתק קישור</button>
            <button class="btn" onclick="goToCampaign()">עבור לקמפיין</button>
        </div>

        <!-- Campaign View Section -->
        <div id="campaignSection" class="card hidden">
            <div id="campaignInfo" class="campaign-info"></div>
            
            <div class="progress-text" id="progressText"></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <h3>בחר פרקי תהילים:</h3>
            <div class="alert alert-info">
                לחץ על מספר פרק כדי לקחת אותו על עצמך. תוכל לקרוא את הטקסט ולסמן כמושלם לאחר הקריאה.
            </div>
            <div class="chapters-grid" id="chaptersGrid"></div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="shareUrl()">שתף קמפיין</button>
                <button class="btn" onclick="showCreateForm()">צור קמפיין חדש</button>
            </div>
        </div>

        <!-- Existing Campaigns -->
        <div id="existingCampaigns" class="card">
            <h3>קמפיינים קיימים</h3>
            <div id="campaignsList" class="campaigns-list">
                <p>אין קמפיינים קיימים</p>
            </div>
        </div>
    </div>

    <!-- Chapter Text Modal -->
    <div id="chapterModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChapterModal()">&times;</span>
            <h2 id="chapterTitle"></h2>
            <div id="chapterContent" class="chapter-text"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" id="completeChapterBtn">סיימתי לקרוא - סמן כמושלם</button>
                <button class="btn" onclick="closeChapterModal()">סגור</button>
            </div>
        </div>
    </div>

    <script>
        class TehillimPlatform {
            constructor() {
                this.currentCampaignId = null;
                this.currentChapterNum = null;
                this.emailConfig = null;
                this.tehillimTexts = this.getTehillimTexts(); // Simplified texts for demo
                this.init();
            }

            init() {
                console.log('Platform initializing...');
                this.loadEmailConfig();
                
                // Wait for EmailJS to load before initializing
                if (typeof emailjs !== 'undefined') {
                    this.initEmailJS();
                } else {
                    console.log('EmailJS not loaded yet, waiting...');
                    setTimeout(() => {
                        if (typeof emailjs !== 'undefined') {
                            this.initEmailJS();
                        } else {
                            console.error('EmailJS failed to load');
                        }
                    }, 1000);
                }
                
                this.loadFromUrl();
                this.displayExistingCampaigns();
                this.setupEventListeners();
            }

            loadEmailConfig() {
                // Show email setup since we need to update the public key
                const savedConfig = localStorage.getItem('tehillimEmailConfig');
                if (savedConfig) {
                    this.emailConfig = JSON.parse(savedConfig);
                    // Still show setup for user to verify/update credentials
                    document.getElementById('emailSetup').style.display = 'block';
                } else {
                    // Show setup section for initial configuration
                    document.getElementById('emailSetup').style.display = 'block';
                }
            }

            initEmailJS() {
                console.log('Initializing EmailJS...');
                console.log('Email config:', JSON.stringify(this.emailConfig, null, 2));
                
                if (typeof emailjs === 'undefined') {
                    console.error('EmailJS library not loaded');
                    return;
                }
                
                if (this.emailConfig && this.emailConfig.userId) {
                    try {
                        // Try both initialization methods
                        console.log('Trying initialization method 1...');
                        emailjs.init(this.emailConfig.userId);
                        console.log('EmailJS initialized successfully with method 1');
                    } catch (error1) {
                        console.log('Method 1 failed, trying method 2...');
                        try {
                            emailjs.init({
                                publicKey: this.emailConfig.userId
                            });
                            console.log('EmailJS initialized successfully with method 2');
                        } catch (error2) {
                            console.error('Both EmailJS initialization methods failed:', error1, error2);
                        }
                    }
                } else {
                    console.error('No email config or user ID found');
                }
            }

            setupEventListeners() {
                document.getElementById('campaignForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createCampaign();
                });
            }

            loadFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const campaignId = urlParams.get('campaign');
                if (campaignId) {
                    this.loadCampaign(campaignId);
                }
            }

            createCampaign() {
                console.log('Creating campaign...');
                
                const name = document.getElementById('campaignName').value;
                const description = document.getElementById('campaignDescription').value;
                const organizer = document.getElementById('organizerName').value;
                const organizerEmail = document.getElementById('organizerEmail').value;

                console.log('Campaign data:', { name, organizer, organizerEmail });

                if (!name || !organizer || !organizerEmail) {
                    alert('יש למלא את כל השדות הנדרשים');
                    return;
                }

                const campaignId = this.generateId();
                const campaign = {
                    id: campaignId,
                    name: name,
                    description: description,
                    organizer: organizer,
                    organizerEmail: organizerEmail,
                    created: new Date().toISOString(),
                    chapters: this.initializeChapters()
                };

                console.log('Generated campaign:', campaign);

                try {
                    // Save to localStorage
                    const campaigns = this.getCampaigns();
                    campaigns[campaignId] = campaign;
                    localStorage.setItem('tehillimCampaigns', JSON.stringify(campaigns));
                    console.log('Campaign saved to localStorage');

                    // Send email to organizer
                    this.sendCampaignCreatedEmail(campaign);

                    // Show URL
                    this.showCampaignUrl(campaignId);
                    
                    // Clear form
                    document.getElementById('campaignForm').reset();
                    
                    console.log('Campaign creation completed');
                } catch (error) {
                    console.error('Error creating campaign:', error);
                    alert('שגיאה ביצירת הקמפיין: ' + error.message);
                }
            }

            async sendCampaignCreatedEmail(campaign) {
                console.log('Attempting to send campaign creation email...');
                console.log('Email config:', JSON.stringify(this.emailConfig, null, 2));
                
                if (typeof emailjs === 'undefined') {
                    console.error('EmailJS library not loaded');
                    alert('שירות המייל לא זמין - הקמפיין נוצר אך המייל לא נשלח');
                    return;
                }
                
                if (!this.emailConfig) {
                    console.error('No email config found');
                    alert('אין הגדרות מייל - הקמפיין נוצר אך המייל לא נשלח');
                    return;
                }

                const campaignUrl = `${window.location.origin}${window.location.pathname}?campaign=${campaign.id}`;
                
                const templateParams = {
                    user_name: campaign.organizer,
                    user_email: campaign.organizerEmail,
                    from_name: "פלטפורמת תהילים",
                    campaign_name: campaign.name,
                    campaign_url: campaignUrl,
                    message: `הקמפיין "${campaign.name}" נוצר בהצלחה! שתף את הקישור עם אחרים כדי שיוכלו להצטרף.`
                };

                console.log('Email template params:', JSON.stringify(templateParams, null, 2));

                try {
                    console.log('Sending email with EmailJS...');
                    const result = await emailjs.send(
                        this.emailConfig.serviceId,
                        this.emailConfig.templateId,
                        templateParams
                    );
                    console.log('Campaign creation email sent successfully:', result);
                    alert('קמפיין נוצר בהצלחה! נשלח מייל עם הקישור');
                } catch (error) {
                    console.error('Email send failed:', error);
                    alert('הקמפיין נוצר אך המייל לא נשלח. שגיאה: ' + (error.text || error.message));
                }
            }

            async sendChapterTakenEmail(campaign, chapterNum, userName, userEmail) {
                if (typeof emailjs === 'undefined' || !this.emailConfig) return;

                const templateParams = {
                    user_name: campaign.organizer,
                    user_email: campaign.organizerEmail,
                    from_name: "פלטפורמת תהילים",
                    campaign_name: campaign.name,
                    chapter_number: chapterNum,
                    participant_name: userName,
                    message: `${userName} לקח על עצמו לקרוא פרק ${chapterNum} בקמפיין "${campaign.name}"`
                };

                try {
                    await emailjs.send(
                        this.emailConfig.serviceId,
                        this.emailConfig.templateId,
                        templateParams
                    );
                } catch (error) {
                    console.error('Email send failed:', error);
                }

                // Send chapter text to user
                if (userEmail) {
                    const userParams = {
                        user_name: userName,
                        user_email: userEmail,
                        from_name: "פלטפורמת תהילים",
                        campaign_name: campaign.name,
                        chapter_number: chapterNum,
                        chapter_text: this.tehillimTexts[chapterNum],
                        message: `פרק ${chapterNum} מתהילים עבור קמפיין "${campaign.name}"`
                    };

                    try {
                        await emailjs.send(
                            this.emailConfig.serviceId,
                            this.emailConfig.templateId,
                            userParams
                        );
                    } catch (error) {
                        console.error('Chapter email send failed:', error);
                    }
                }
            }

            async sendChapterCompletedEmail(campaign, chapterNum, userName) {
                if (!this.emailConfig) return;

                const templateParams = {
                    to_name: campaign.organizer,
                    to_email: campaign.organizerEmail,
                    campaign_name: campaign.name,
                    chapter_number: chapterNum,
                    user_name: userName,
                    message: `${userName} סיים לקרוא פרق ${chapterNum} בקמפיין "${campaign.name}"!`
                };

                try {
                    await emailjs.send(
                        this.emailConfig.serviceId,
                        this.emailConfig.templateId,
                        templateParams
                    );
                } catch (error) {
                    console.error('Email send failed:', error);
                }
            }

            initializeChapters() {
                const chapters = {};
                for (let i = 1; i <= 150; i++) {
                    chapters[i] = {
                        status: 'available', // available, taken, completed
                        takenBy: null,
                        takenByEmail: null,
                        completedAt: null
                    };
                }
                return chapters;
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            getCampaigns() {
                const campaigns = localStorage.getItem('tehillimCampaigns');
                return campaigns ? JSON.parse(campaigns) : {};
            }

            showCampaignUrl(campaignId) {
                const baseUrl = window.location.origin + window.location.pathname;
                const campaignUrl = `${baseUrl}?campaign=${campaignId}`;
                
                document.getElementById('campaignUrl').textContent = campaignUrl;
                document.getElementById('createSection').classList.add('hidden');
                document.getElementById('urlSection').classList.remove('hidden');
                
                this.currentCampaignId = campaignId;
            }

            loadCampaign(campaignId) {
                const campaigns = this.getCampaigns();
                const campaign = campaigns[campaignId];

                if (!campaign) {
                    alert('קמפיין לא נמצא');
                    return;
                }

                this.currentCampaignId = campaignId;
                this.displayCampaign(campaign);
            }

            displayCampaign(campaign) {
                document.getElementById('createSection').classList.add('hidden');
                document.getElementById('urlSection').classList.add('hidden');
                document.getElementById('campaignSection').classList.remove('hidden');

                // Display campaign info
                const infoDiv = document.getElementById('campaignInfo');
                infoDiv.innerHTML = `
                    <h2>${campaign.name}</h2>
                    ${campaign.description ? `<p><strong>תיאור:</strong> ${campaign.description}</p>` : ''}
                    <p><strong>מארגן:</strong> ${campaign.organizer}</p>
                    <p><strong>נוצר:</strong> ${new Date(campaign.created).toLocaleDateString('he-IL')}</p>
                `;

                // Display chapters
                this.displayChapters(campaign.chapters);
                this.updateProgress(campaign.chapters);
            }

            displayChapters(chapters) {
                const grid = document.getElementById('chaptersGrid');
                grid.innerHTML = '';

                for (let i = 1; i <= 150; i++) {
                    const chapter = chapters[i];
                    const btn = document.createElement('div');
                    btn.className = `chapter-btn ${chapter.status}`;
                    btn.textContent = i;
                    btn.onclick = () => this.handleChapterClick(i);
                    
                    if (chapter.status === 'taken') {
                        btn.title = `נלקח על ידי: ${chapter.takenBy || 'אלמוני'}`;
                    } else if (chapter.status === 'completed') {
                        btn.title = `הושלם על ידי: ${chapter.takenBy || 'אלמוני'}`;
                    }
                    
                    grid.appendChild(btn);
                }
            }

            handleChapterClick(chapterNum) {
                const campaigns = this.getCampaigns();
                const campaign = campaigns[this.currentCampaignId];
                const chapter = campaign.chapters[chapterNum];

                if (chapter.status === 'available') {
                    this.takeChapter(chapterNum);
                } else if (chapter.status === 'taken') {
                    this.showChapterText(chapterNum);
                } else {
                    alert('פרק זה כבר הושלם');
                }
            }

            takeChapter(chapterNum) {
                const name = prompt('הכנס את שמך:');
                if (!name) return;

                const email = prompt('הכנס את כתובת המייל שלך:');
                if (!email) return;

                const campaigns = this.getCampaigns();
                const campaign = campaigns[this.currentCampaignId];
                const chapter = campaign.chapters[chapterNum];

                chapter.status = 'taken';
                chapter.takenBy = name;
                chapter.takenByEmail = email;

                // Save changes
                localStorage.setItem('tehillimCampaigns', JSON.stringify(campaigns));
                
                // Send emails
                this.sendChapterTakenEmail(campaign, chapterNum, name, email);

                // Refresh display
                this.displayChapters(campaign.chapters);
                this.updateProgress(campaign.chapters);

                // Show chapter text
                this.showChapterText(chapterNum);
            }

            showChapterText(chapterNum) {
                this.currentChapterNum = chapterNum;
                
                document.getElementById('chapterTitle').textContent = `תהילים פרק ${chapterNum}`;
                document.getElementById('chapterContent').textContent = this.tehillimTexts[chapterNum];
                document.getElementById('chapterModal').style.display = 'block';

                // Set up complete button
                document.getElementById('completeChapterBtn').onclick = () => this.completeChapter(chapterNum);
            }

            completeChapter(chapterNum) {
                const campaigns = this.getCampaigns();
                const campaign = campaigns[this.currentCampaignId];
                const chapter = campaign.chapters[chapterNum];

                if (chapter.status !== 'taken') {
                    alert('לא ניתן לסמן פרק שלא נלקח');
                    return;
                }

                const confirm = window.confirm(`האם סיימת לקרוא פרק ${chapterNum}?`);
                if (!confirm) return;

                chapter.status = 'completed';
                chapter.completedAt = new Date().toISOString();

                // Save changes
                localStorage.setItem('tehillimCampaigns', JSON.stringify(campaigns));

                // Send completion email
                this.sendChapterCompletedEmail(campaign, chapterNum, chapter.takenBy);

                // Refresh display
                this.displayChapters(campaign.chapters);
                this.updateProgress(campaign.chapters);

                // Close modal
                this.closeChapterModal();

                alert('תודה על השלמת הפרק!');
            }

            closeChapterModal() {
                document.getElementById('chapterModal').style.display = 'none';
            }

            updateProgress(chapters) {
                const total = 150;
                const completed = Object.values(chapters).filter(ch => ch.status === 'completed').length;
                const taken = Object.values(chapters).filter(ch => ch.status === 'taken').length;
                const available = total - completed - taken;

                const percentage = (completed / total) * 100;
                
                document.getElementById('progressFill').style.width = `${percentage}%`;
                document.getElementById('progressText').innerHTML = `
                    הושלמו: ${completed} | נלקחו: ${taken} | זמינים: ${available} | סה"כ: ${total} (${Math.round(percentage)}%)
                `;
            }

            displayExistingCampaigns() {
                console.log('Displaying existing campaigns...');
                const campaigns = this.getCampaigns();
                console.log('Found campaigns:', JSON.stringify(campaigns, null, 2));
                
                const listDiv = document.getElementById('campaignsList');
                
                const campaignIds = Object.keys(campaigns || {});
                console.log('Campaign IDs:', campaignIds);
                
                if (campaignIds.length === 0) {
                    listDiv.innerHTML = '<p>אין קמפיינים קיימים</p>';
                    return;
                }

                listDiv.innerHTML = '';
                campaignIds.forEach(id => {
                    const campaign = campaigns[id];
                    if (!campaign || !campaign.chapters) {
                        console.error('Invalid campaign data for ID:', id);
                        return;
                    }
                    
                    const completed = Object.values(campaign.chapters).filter(ch => ch && ch.status === 'completed').length;
                    const percentage = Math.round((completed / 150) * 100);

                    const item = document.createElement('div');
                    item.className = 'campaign-item';
                    item.onclick = () => this.loadCampaign(id);
                    item.innerHTML = `
                        <strong>${campaign.name || 'ללא שם'}</strong><br>
                        <small>מארגן: ${campaign.organizer || 'לא ידוע'} | הושלמו: ${completed}/150 (${percentage}%)</small>
                    `;
                    listDiv.appendChild(item);
                });
                
                console.log('Existing campaigns displayed');
            }

            showCreateForm() {
                document.getElementById('campaignSection').classList.add('hidden');
                document.getElementById('urlSection').classList.add('hidden');
                document.getElementById('createSection').classList.remove('hidden');
                
                // Clear URL parameter
                window.history.pushState({}, document.title, window.location.pathname);
            }

            getTehillimTexts() {
                // This is a simplified version with just a few sample texts
                // In a real implementation, you'd have all 150 chapters
                const texts = {};
                for (let i = 1; i <= 150; i++) {
                    texts[i] = `זהו טקסט לדוגמה של פרק ${i} מתהילים. בגרסה מלאה יהיה כאן הטקסט המלא של כל פרק.\n\nכאן יופיע הטקסט המלא של פרק ${i} בתהילים כפי שנכתב במקורות היהדות.\n\n(בגרסה זו מוצג טקסט לדוגמה בלבד)`;
                }
                
                // Sample actual text for chapter 1
                texts[1] = `אַשְׁרֵי הָאִישׁ אֲשֶׁר לֹא הָלַךְ בַּעֲצַת רְשָׁעִים וּבְדֶרֶךְ חַטָּאִים לֹא עָמָד וּבְמוֹשַׁב לֵצִים לֹא יָשָׁב:
כִּי אִם בְּתוֹרַת יְהוָה חֶפְצוֹ וּבְתוֹרָתוֹ יֶהְגֶּה יוֹמָם וָלָיְלָה:
וְהָיָה כְּעֵץ שָׁתוּל עַל פַּלְגֵי מָיִם אֲשֶׁר פִּרְיוֹ יִתֵּן בְּעִתּוֹ וְעָלֵהוּ לֹא יִבּוֹל וְכֹל אֲשֶׁר יַעֲשֶׂה יַצְלִיחַ:
לֹא כֵן הָרְשָׁעִים כִּי אִם כַּמֹּץ אֲשֶׁר תִּדְּפֶנּוּ רוּחַ:
עַל כֵּן לֹא יָקֻמוּ רְשָׁעִים בַּמִּשְׁפָּט וְחַטָּאִים בַּעֲדַת צַדִּיקִים:
כִּי יוֹדֵעַ יְהוָה דֶּרֶךְ צַדִּיקִים וְדֶרֶךְ רְשָׁעִים תֹּאבֵד:`;

                // Sample text for chapter 23 (popular psalm)
                texts[23] = `מִזְמוֹר לְדָוִד יְהוָה רֹעִי לֹא אֶחְסָר:
בִּנְאוֹת דֶּשֶׁא יַרְבִּיצֵנִי עַל מֵי מְנֻחוֹת יְנַהֲלֵנִי:
נַפְשִׁי יְשׁוֹבֵב יַנְחֵנִי בְמַעְגְּלֵי צֶדֶק לְמַעַן שְׁמוֹ:
גַּם כִּי אֵלֵךְ בְּגֵיא צַלְמָוֶת לֹא אִירָא רָע כִּי אַתָּה עִמָּדִי שִׁבְטְךָ וּמִשְׁעַנְתֶּךָ הֵמָּה יְנַחֲמֻנִי:
תַּעֲרֹךְ לְפָנַי שֻׁלְחָן נֶגֶד צֹרְרָי דִּשַּׁנְתָּ בַשֶּׁמֶן רֹאשִׁי כּוֹסִי רְוָיָה:
אַךְ טוֹב וָחֶסֶד יִרְדְּפוּנִי כָּל יְמֵי חַיָּי וְשַׁבְתִּי בְּבֵית יְהוָה לְאֹרֶךְ יָמִים:`;

                return texts;
            }
        }

        // Global functions
        function saveEmailConfig() {
            const userId = document.getElementById('emailjsUserId').value;
            const serviceId = document.getElementById('emailjsServiceId').value;
            const templateId = document.getElementById('emailjsTemplateId').value;

            if (!userId || !serviceId || !templateId) {
                alert('יש למלא את כל השדות');
                return;
            }

            const config = { userId, serviceId, templateId };
            localStorage.setItem('tehillimEmailConfig', JSON.stringify(config));
            
            window.tehillimPlatform.emailConfig = config;
            window.tehillimPlatform.initEmailJS();
            
            document.getElementById('emailSetup').style.display = 'none';
            alert('הגדרות המייל נשמרו בהצלחה!');
        }

        function hideEmailSetup() {
            document.getElementById('emailSetup').style.display = 'none';
        }

        function copyUrl() {
            const url = document.getElementById('campaignUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('הקישור הועתק ללוח!');
            });
        }

        function goToCampaign() {
            const campaigns = window.tehillimPlatform.getCampaigns();
            const campaign = campaigns[window.tehillimPlatform.currentCampaignId];
            
            // Hide URL section and show campaign
            document.getElementById('urlSection').classList.add('hidden');
            window.tehillimPlatform.displayCampaign(campaign);
            
            // Update URL without page reload
            const baseUrl = window.location.origin + window.location.pathname;
            const newUrl = `${baseUrl}?campaign=${window.tehillimPlatform.currentCampaignId}`;
            window.history.pushState({}, document.title, newUrl);
        }

        function shareUrl() {
            const baseUrl = window.location.origin + window.location.pathname;
            const url = `${baseUrl}?campaign=${window.tehillimPlatform.currentCampaignId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'קמפיין תהילים',
                    text: 'הצטרף אלי לקמפיין תהילים',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('הקישור הועתק ללוח!');
                });
            }
        }

        function closeChapterModal() {
            document.getElementById('chapterModal').style.display = 'none';
        }

        // Initialize the platform
        window.tehillimPlatform = new TehillimPlatform();

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('chapterModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
