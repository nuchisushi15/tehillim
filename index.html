<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™× â€” ×§××¤×™×™× ×™× + × ×™×”×•×œ</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    /* (same CSS as before for layout, admin log, modal, etc.) */
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toasts" class="toasts" aria-live="polite"></div>

  <!-- Chapter Modal -->
  <div id="chapterModal" class="modal">
    <div class="backdrop" onclick="closeChapterModal()"></div>
    <div class="dialog" style="width:min(720px, 92vw)">
      <header>
        <button class="close-x" onclick="closeChapterModal()">Ã—</button>
        <h3 id="chapterTitle" style="margin:0"></h3>
      </header>
      <div id="chapterContent" class="content" style="white-space:pre-wrap; line-height:2; font-size:18px"></div>
      <div class="actions">
        <button class="btn success" id="finishChapterBtn" style="display:none">×¡×™×™××ª×™</button>
        <button class="btn ghost" onclick="closeChapterModal()">×¡×’×•×¨</button>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminModal" class="modal">
    <div class="backdrop" onclick="closeAdmin()"></div>
    <div class="dialog">
      <header>
        <h3>× ×™×”×•×œ ×§××¤×™×™× ×™×</h3>
        <button class="close-x" onclick="closeAdmin()">Ã—</button>
      </header>
      <div class="content">
        <div class="toolbar">
          <input id="adminSearch" class="input-sm" placeholder="×—×™×¤×•×© ×‘×©×/×××¨×’×Ÿâ€¦" oninput="renderAdminList()">
          <input id="openById" class="input-sm" placeholder="×¤×ª×— ×œ×¤×™ ××–×”×” ×§××¤×™×™×Ÿ">
          <button class="btn small light" onclick="openCampaignById()">×¤×ª×—</button>
          <span style="flex:1"></span>
          <button class="btn small" onclick="exportCampaigns()">×™×™×¦×•×</button>
          <label class="btn small ghost">
            ×™×™×‘×•× <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importCampaigns(event)">
          </label>
        </div>
        <div class="admin-head"><div>×©×</div><div>×ª×™××•×¨</div><div>×××¨×’×Ÿ</div><div>××™×™×œ</div><div>×¤×¢×•×œ×•×ª</div></div>
        <div id="adminList" class="admin-grid"></div>
      </div>
      <div class="actions"><button class="btn ghost" onclick="closeAdmin()">×¡×’×•×¨</button></div>
    </div>
  </div>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand"><div class="logo"></div> ×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™×</div>
      <div class="top-actions">
        <button class="btn ghost" onclick="openAdmin()">× ×™×”×•×œ</button>
        <button class="btn success" onclick="showCreateForm()">×§××¤×™×™×Ÿ ×—×“×©</button>
      </div>
    </div>
  </header>

  <!-- Shell -->
  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="card panel">
        <h3>×™×¦×™×¨×ª ×§××¤×™×™×Ÿ</h3>
        <form id="campaignForm" class="form">
          <div class="row"><label>×©×</label><input id="campaignName" required></div>
          <div class="row"><label>×ª×™××•×¨</label><textarea id="campaignDescription"></textarea></div>
          <div class="row"><label>×××¨×’×Ÿ</label><input id="organizerName" required></div>
          <div class="row"><label>××™×™×œ</label><input id="organizerEmail" type="email" required></div>
          <button class="btn" type="submit">×¦×•×¨ ×§××¤×™×™×Ÿ</button>
        </form>
      </div>
      <div class="card panel" style="margin-top:14px">
        <h3>×§××¤×™×™× ×™× ××—×¨×•× ×™×</h3>
        <div id="campaignsList" class="campaigns"><div class="muted">××™×Ÿ ×§××¤×™×™× ×™×</div></div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <section id="campaignSection" class="card panel" style="display:none">
        <div id="copyBar" class="copybar" style="display:none">
          <div id="campaignUrl" class="urlbox" style="flex:1"></div>
          <button class="btn light" onclick="copyUrl()">×”×¢×ª×§ ×§×™×©×•×¨</button>
        </div>
        <div id="campaignInfo" class="stack"></div>
        <div class="card panel" style="background:#faf5ff;margin-top:10px">
          <h3>×œ×¤× ×™ × ×˜×™×œ×ª ×¤×¨×§</h3>
          <input id="participantName" placeholder="×©× ××œ×">
          <input id="participantEmail" type="email" placeholder="email">
        </div>
        <div class="progress">
          <div id="progressText"></div>
          <div class="bar"><div id="progressFill" class="fill"></div></div>
        </div>
        <div class="section"><h3>×‘×—×¨×• ×¤×¨×§×™×</h3><div id="chaptersGrid" class="grid"></div></div>
      </section>
    </main>
  </div>

  <script>
    /* helper functions showToast, toHebNum, TehillimPlatform, Admin Log etc.
       (same as before, omitted here for brevity â€” keep the version you already have!) */
  </script>

  <!-- ğŸ”„ Updated Sefaria loader -->
  <script>
    const _psalmsCache = new Map();

    async function fetchChapterFromSefaria(chNum){
      if (_psalmsCache.has(chNum)) return _psalmsCache.get(chNum);
      const url = `https://www.sefaria.org/api/texts/Psalms.${chNum}?lang=he&commentary=0`;
      const res = await fetch(url, {mode:'cors'});
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const verses = Array.isArray(data.he) ? data.he : [];

      const clean = verses.map((v,i)=>{
        let text = v.replace(/<[^>]+>/g,'').trim();   // remove tags
        text = text.replace(/\s+/g,' ');              // collapse spaces
        return `(${toHebNum(i+1,false)}) ${text}`;
      });

      const text = clean.join('\n');
      _psalmsCache.set(chNum, text);
      if (window.tehillimPlatform){
        window.tehillimPlatform.tehillimTexts[chNum] = text;
      }
      return text;
    }
  </script>
</body>
</html>
