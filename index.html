<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™× - Tehillim Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .create-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], input[type="email"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            direction: rtl;
        }

        input[type="email"] {
            direction: ltr;
        }

        input[type="text"]:focus, input[type="email"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .url-display {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            direction: ltr;
            text-align: center;
            font-family: monospace;
            font-size: 14px;
        }

        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .chapter-btn {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .chapter-btn:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .chapter-btn.taken {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .chapter-btn.completed {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }

        .campaign-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid #667eea;
        }

        .hidden {
            display: none;
        }

        .campaigns-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .campaign-item {
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .campaign-item:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .chapter-text {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            direction: rtl;
            text-align: right;
            line-height: 2;
            font-size: 18px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            direction: rtl;
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .email-setup {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .chapters-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 8px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .modal-content {
                margin: 2% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™×</h1>
            <p>×™×•×¦×¨×™× ×§××¤×™×™× ×™× ×•××©×œ×™××™× ×ª×”×™×œ×™× ×™×—×“</p>
        </div>

        <!-- Email Setup Section -->
        <div id="emailSetup" class="card email-setup">
            <h3>×”×’×“×¨×ª ×©×™×¨×•×ª ××™×™×œ</h3>
            <p>×™×© ×¦×•×¨×š ×‘-3 ×ª×‘× ×™×•×ª ××™×™×œ ×©×•× ×•×ª. ×¦×•×¨ ××•×ª×Ÿ ×‘-EmailJS ×•×”×›× ×¡ ××ª ×”××–×”×™×:</p>
            <div class="alert alert-info">
                <strong>×ª×‘× ×™×•×ª × ×“×¨×©×•×ª:</strong><br>
                1. ×™×¦×™×¨×ª ×§××¤×™×™×Ÿ - ×œ×©×œ×™×—×” ×œ×××¨×’×Ÿ<br>
                2. × ×˜×™×œ×ª ×¤×¨×§ - ×œ×©×œ×™×—×” ×œ××©×ª×ª×£ ×¢× ×˜×§×¡×˜ ×”×¤×¨×§<br>
                3. ×”×©×œ××ª ×¤×¨×§ - ×œ×©×œ×™×—×” ×œ×××¨×’×Ÿ
            </div>
            
            <div class="form-group">
                <label for="emailjsUserId">EmailJS Public Key:</label>
                <input type="text" id="emailjsUserId" value="d_LsqV-KBZuAeuCjf">
            </div>
            <div class="form-group">
                <label for="emailjsServiceId">EmailJS Service ID:</label>
                <input type="text" id="emailjsServiceId" value="service_p76h23d">
            </div>
            
            <h4>×ª×‘× ×™×•×ª ××™×™×œ:</h4>
            <div class="form-group">
                <label for="campaignCreatedTemplateId">×ª×‘× ×™×ª ×™×¦×™×¨×ª ×§××¤×™×™×Ÿ (Campaign Created):</label>
                <input type="text" id="campaignCreatedTemplateId" value="template_0hmmrlk">
            </div>
            <div class="form-group">
                <label for="chapterTakenTemplateId">×ª×‘× ×™×ª × ×˜×™×œ×ª ×¤×¨×§ (Chapter Taken):</label>
                <input type="text" id="chapterTakenTemplateId" value="template_swui2zf">
            </div>
            <div class="form-group">
                <label for="chapterCompletedTemplateId">×ª×‘× ×™×ª ×”×©×œ××ª ×¤×¨×§ (Chapter Completed):</label>
                <input type="text" id="chapterCompletedTemplateId" value="template_j01dkdf">
            </div>
            
            <button class="btn" onclick="saveEmailConfig()">×©××•×¨ ×”×’×“×¨×•×ª</button>
            <button class="btn btn-secondary" onclick="hideEmailSetup()">×“×œ×’ ×œ×¢×ª ×¢×ª×”</button>
        </div>

        <!-- Create Campaign Section -->
        <div id="createSection" class="card create-section">
            <h2>×™×¦×™×¨×ª ×§××¤×™×™×Ÿ ×—×“×©</h2>
            <form id="campaignForm">
                <div class="form-group">
                    <label for="campaignName">×©× ×”×§××¤×™×™×Ÿ:</label>
                    <input type="text" id="campaignName" required placeholder="×œ×¨×¤×•××ª... / ×œ×¢×™×œ×•×™ × ×©××ª... / ×œ×–×›×•×ª...">
                </div>
                <div class="form-group">
                    <label for="campaignDescription">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™):</label>
                    <textarea id="campaignDescription" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ ×”×§××¤×™×™×Ÿ..."></textarea>
                </div>
                <div class="form-group">
                    <label for="organizerName">×©× ×”×××¨×’×Ÿ:</label>
                    <input type="text" id="organizerName" required placeholder="×”×©× ×©×œ×š">
                </div>
                <div class="form-group">
                    <label for="organizerEmail">××™×™×œ ×”×××¨×’×Ÿ:</label>
                    <input type="email" id="organizerEmail" required placeholder="your@email.com">
                </div>
                <button type="submit" class="btn">×¦×•×¨ ×§××¤×™×™×Ÿ</button>
            </form>
        </div>

        <!-- Campaign URL Display -->
        <div id="urlSection" class="card hidden">
            <h3>×§××¤×™×™×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”!</h3>
            <div class="alert alert-success">
                ×©×ª×£ ××ª ×”×§×™×©×•×¨ ×”×–×” ×¢× ××—×¨×™× ×›×“×™ ×©×™×•×›×œ×• ×œ×”×¦×˜×¨×£ ×œ×§××¤×™×™×Ÿ. × ×©×œ×— ××™×™×œ ×¢× ×”×§×™×©×•×¨ ×œ×›×ª×•×‘×ª ×©×”×–× ×ª.
            </div>
            <div class="url-display" id="campaignUrl"></div>
            <button class="btn btn-secondary" onclick="copyUrl()">×”×¢×ª×§ ×§×™×©×•×¨</button>
            <button class="btn" onclick="goToCampaign()">×¢×‘×•×¨ ×œ×§××¤×™×™×Ÿ</button>
        </div>

        <!-- Campaign View Section -->
        <div id="campaignSection" class="card hidden">
            <div id="campaignInfo" class="campaign-info"></div>
            
            <!-- User Input Section -->
            <div class="card" style="background: #e8f4fd; border: 2px solid #667eea;">
                <h3>×”×–×Ÿ ××ª ×”×¤×¨×˜×™× ×©×œ×š ×œ×¤× ×™ × ×˜×™×œ×ª ×¤×¨×§:</h3>
                <div class="form-group">
                    <label for="participantName">×”×©× ×©×œ×š:</label>
                    <input type="text" id="participantName" placeholder="×”×›× ×¡ ××ª ×©××š ×”××œ×">
                </div>
                <div class="form-group">
                    <label for="participantEmail">×›×ª×•×‘×ª ×”××™×™×œ ×©×œ×š:</label>
                    <input type="email" id="participantEmail" placeholder="your@email.com">
                </div>
                <div class="alert alert-info">
                    ×œ××—×¨ ××™×œ×•×™ ×”×¤×¨×˜×™×, ×œ×—×¥ ×¢×œ ××¡×¤×¨ ×¤×¨×§ ×›×“×™ ×œ×§×‘×œ ××ª ×”×˜×§×¡×˜ ×‘××™×™×œ
                </div>
            </div>
            
            <div class="progress-text" id="progressText"></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <h3>×‘×—×¨ ×¤×¨×§×™ ×ª×”×™×œ×™×:</h3>
            <div class="alert alert-info">
                ×œ×—×¥ ×¢×œ ××¡×¤×¨ ×¤×¨×§ ×›×“×™ ×œ×§×—×ª ××•×ª×• ×¢×œ ×¢×¦××š. ×ª×§×‘×œ ××ª ×”×˜×§×¡×˜ ×”××œ× ×‘××™×™×œ ×•×ª×•×›×œ ×œ×¡××Ÿ ×›××•×©×œ× ×œ××—×¨ ×”×§×¨×™××”.
            </div>
            <div class="chapters-grid" id="chaptersGrid"></div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="shareUrl()">×©×ª×£ ×§××¤×™×™×Ÿ</button>
                <button class="btn" onclick="showCreateForm()">×¦×•×¨ ×§××¤×™×™×Ÿ ×—×“×©</button>
            </div>
        </div>

        <!-- Existing Campaigns -->
        <div id="existingCampaigns" class="card">
            <h3>×§××¤×™×™× ×™× ×§×™×™××™×</h3>
            <div id="campaignsList" class="campaigns-list">
                <p>××™×Ÿ ×§××¤×™×™× ×™× ×§×™×™××™×</p>
            </div>
        </div>
    </div>

    <!-- Chapter Text Modal -->
    <div id="chapterModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChapterModal()">&times;</span>
            <h2 id="chapterTitle"></h2>
            <div id="chapterContent" class="chapter-text"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" id="completeChapterBtn">×¡×™×™××ª×™ ×œ×§×¨×•× - ×¡××Ÿ ×›××•×©×œ×</button>
                <button class="btn" onclick="closeChapterModal()">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <script>
        class TehillimPlatform {
            constructor() {
                this.currentCampaignId = null;
                this.currentChapterNum = null;
                this.emailConfig = null;
                this.tehillimTexts = this.getTehillimTexts(); // Simplified texts for demo
                this.init();
            }

            init() {
                console.log('Platform initializing...');
                this.loadEmailConfig();
                
                // Wait for EmailJS to load before initializing
                if (typeof emailjs !== 'undefined') {
                    this.initEmailJS();
                } else {
                    console.log('EmailJS not loaded yet, waiting...');
                    setTimeout(() => {
                        if (typeof emailjs !== 'undefined') {
                            this.initEmailJS();
                        } else {
                            console.error('EmailJS failed to load');
                        }
                    }, 1000);
                }
                
                this.loadFromUrl();
                this.displayExistingCampaigns();
                this.setupEventListeners();
                
                // Debug email config after initialization
                setTimeout(() => {
                    console.log('=== EMAIL CONFIG DEBUG ===');
                    console.log('Email config exists:', !!this.emailConfig);
                    if (this.emailConfig) {
                        console.log('Campaign template ID:', this.emailConfig.campaignCreatedTemplateId);
                        console.log('Chapter taken template ID:', this.emailConfig.chapterTakenTemplateId);
                        console.log('Chapter completed template ID:', this.emailConfig.chapterCompletedTemplateId);
                    }
                }, 2000);
            }

            loadEmailConfig() {
                console.log('Loading email configuration...');
                
                // Auto-configure with your EmailJS settings including all 3 templates
                const defaultConfig = {
                    userId: 'd_LsqV-KBZuAeuCjf',
                    serviceId: 'service_p76h23d',
                    campaignCreatedTemplateId: 'template_0hmmrlk',
                    chapterTakenTemplateId: 'template_swui2zf',
                    chapterCompletedTemplateId: 'template_j01dkdf'
                };

                const savedConfig = localStorage.getItem('tehillimEmailConfig');
                let needsUpdate = false;
                
                if (savedConfig) {
                    const parsed = JSON.parse(savedConfig);
                    // Check if we have the old format with single templateId
                    if (parsed.templateId && !parsed.campaignCreatedTemplateId) {
                        console.log('Found old email config format, updating...');
                        needsUpdate = true;
                    } else {
                        this.emailConfig = parsed;
                        console.log('Loaded saved email config:', this.emailConfig);
                    }
                } else {
                    needsUpdate = true;
                }
                
                if (needsUpdate) {
                    // Use default config with all templates
                    this.emailConfig = defaultConfig;
                    // Save to localStorage
                    localStorage.setItem('tehillimEmailConfig', JSON.stringify(defaultConfig));
                    console.log('Updated to new email config format:', this.emailConfig);
                }
                
                // Verify all template IDs are present
                if (!this.emailConfig.campaignCreatedTemplateId || 
                    !this.emailConfig.chapterTakenTemplateId || 
                    !this.emailConfig.chapterCompletedTemplateId) {
                    console.warn('Missing template IDs, forcing update...');
                    this.emailConfig = defaultConfig;
                    localStorage.setItem('tehillimEmailConfig', JSON.stringify(defaultConfig));
                }
                
                console.log('Final email config:', JSON.stringify(this.emailConfig, null, 2));
                
                // Hide setup section since we have complete config
                document.getElementById('emailSetup').style.display = 'none';
            }

            initEmailJS() {
                console.log('Initializing EmailJS...');
                console.log('Email config:', JSON.stringify(this.emailConfig, null, 2));
                
                if (typeof emailjs === 'undefined') {
                    console.error('EmailJS library not loaded');
                    return;
                }
                
                if (this.emailConfig && this.emailConfig.userId) {
                    try {
                        // Try both initialization methods
                        console.log('Trying initialization method 1...');
                        emailjs.init(this.emailConfig.userId);
                        console.log('EmailJS initialized successfully with method 1');
                    } catch (error1) {
                        console.log('Method 1 failed, trying method 2...');
                        try {
                            emailjs.init({
                                publicKey: this.emailConfig.userId
                            });
                            console.log('EmailJS initialized successfully with method 2');
                        } catch (error2) {
                            console.error('Both EmailJS initialization methods failed:', error1, error2);
                        }
                    }
                } else {
                    console.error('No email config or user ID found');
                }
            }

            setupEventListeners() {
                document.getElementById('campaignForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createCampaign();
                });
            }

            loadFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const campaignId = urlParams.get('campaign');
                if (campaignId) {
                    this.loadCampaign(campaignId);
                }
            }

            createCampaign() {
                console.log('Creating campaign...');
                
                const name = document.getElementById('campaignName').value;
                const description = document.getElementById('campaignDescription').value;
                const organizer = document.getElementById('organizerName').value;
                const organizerEmail = document.getElementById('organizerEmail').value;

                console.log('Campaign data:', { name, organizer, organizerEmail });

                if (!name || !organizer || !organizerEmail) {
                    alert('×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
                    return;
                }

                const campaignId = this.generateId();
                const campaign = {
                    id: campaignId,
                    name: name,
                    description: description,
                    organizer: organizer,
                    organizerEmail: organizerEmail,
                    created: new Date().toISOString(),
                    chapters: this.initializeChapters()
                };

                console.log('Generated campaign:', campaign);

                try {
                    // Save to localStorage
                    const campaigns = this.getCampaigns();
                    campaigns[campaignId] = campaign;
                    localStorage.setItem('tehillimCampaigns', JSON.stringify(campaigns));
                    console.log('Campaign saved to localStorage');

                    // Send email to organizer
                    this.sendCampaignCreatedEmail(campaign);

                    // Show URL
                    this.showCampaignUrl(campaignId);
                    
                    // Clear form
                    document.getElementById('campaignForm').reset();
                    
                    console.log('Campaign creation completed');
                } catch (error) {
                    console.error('Error creating campaign:', error);
                    alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×§××¤×™×™×Ÿ: ' + error.message);
                }
            }

            async sendCampaignCreatedEmail(campaign) {
                console.log('=== SENDING CAMPAIGN CREATED EMAIL ===');
                console.log('Campaign:', JSON.stringify(campaign, null, 2));
                console.log('Email config:', JSON.stringify(this.emailConfig, null, 2));
                
                if (typeof emailjs === 'undefined') {
                    console.error('âŒ EmailJS library not loaded');
                    alert('EmailJS ×œ× × ×˜×¢×Ÿ');
                    return;
                }
                
                if (!this.emailConfig) {
                    console.error('âŒ No email config');
                    alert('××™×Ÿ ×”×’×“×¨×•×ª ××™×™×œ');
                    return;
                }
                
                if (!this.emailConfig.campaignCreatedTemplateId) {
                    console.error('âŒ No campaign template ID');
                    alert('××™×Ÿ ××–×”×” ×ª×‘× ×™×ª ×œ×§××¤×™×™×Ÿ');
                    return;
                }

                const campaignUrl = `${window.location.origin}${window.location.pathname}?campaign=${campaign.id}`;
                
                const templateParams = {
                    to_email: campaign.organizerEmail,
                    to_name: campaign.organizer,
                    from_name: "×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™×",
                    campaign_name: campaign.name,
                    campaign_url: campaignUrl,
                    message: `×”×§××¤×™×™×Ÿ "${campaign.name}" × ×•×¦×¨ ×‘×”×¦×œ×—×”! ×©×ª×£ ××ª ×”×§×™×©×•×¨ ×¢× ××—×¨×™× ×›×“×™ ×©×™×•×›×œ×• ×œ×”×¦×˜×¨×£.`,
                    subject: `×§××¤×™×™×Ÿ ×ª×”×™×œ×™× × ×•×¦×¨ - ${campaign.name}`
                };

                console.log('ğŸ“§ Template params:', JSON.stringify(templateParams, null, 2));
                console.log('ğŸ“¨ Sending to service:', this.emailConfig.serviceId);
                console.log('ğŸ“„ Using template:', this.emailConfig.campaignCreatedTemplateId);

                try {
                    console.log('ğŸš€ Starting email send...');
                    const result = await emailjs.send(
                        this.emailConfig.serviceId,
                        this.emailConfig.campaignCreatedTemplateId,
                        templateParams
                    );
                    console.log('âœ… Email sent successfully!', result);
                    alert('×§××¤×™×™×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”! × ×©×œ×— ××™×™×œ ×¢× ×”×§×™×©×•×¨');
                } catch (error) {
                    console.error('âŒ Email send failed:', error);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    
                    // Try to give more specific error info
                    let errorMessage = '×©×’×™××” ×œ× ×™×“×•×¢×”';
                    if (error.text) {
                        errorMessage = error.text;
                    } else if (error.message) {
                        errorMessage = error.message;
                    } else if (typeof error === 'string') {
                        errorMessage = error;
                    }
                    
                    alert('×”×§××¤×™×™×Ÿ × ×•×¦×¨ ××š ×”××™×™×œ ×œ× × ×©×œ×—. ×©×’×™××”: ' + errorMessage);
                }
            }

            async sendChapterTakenEmail(campaign, chapterNum, userName, userEmail) {
                if (typeof emailjs === 'undefined' || !this.emailConfig) return;

                // Send notification to campaign organizer
                if (this.emailConfig.chapterCompletedTemplateId) {
                    const organizerParams = {
                        to_email: campaign.organizerEmail,
                        to_name: campaign.organizer,
                        from_name: "×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™×",
                        campaign_name: campaign.name,
                        chapter_number: chapterNum,
                        participant_name: userName,
                        participant_email: userEmail,
                        message: `${userName} ×œ×§×— ×¢×œ ×¢×¦××• ×œ×§×¨×•× ×¤×¨×§ ${chapterNum} ×‘×§××¤×™×™×Ÿ "${campaign.name}"`,
                        subject: `×¤×¨×§ × ×œ×§×— - ${campaign.name}`
                    };

                    try {
                        await emailjs.send(
                            this.emailConfig.serviceId,
                            this.emailConfig.chapterCompletedTemplateId,
                            organizerParams
                        );
                        console.log('Organizer notification sent');
                    } catch (error) {
                        console.error('Organizer notification failed:', error);
                    }
                }

                // Send chapter text to participant
                if (userEmail && this.emailConfig.chapterTakenTemplateId) {
                    const userParams = {
                        to_email: userEmail,
                        to_name: userName,
                        from_name: "×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™×",
                        campaign_name: campaign.name,
                        chapter_number: chapterNum,
                        chapter_text: this.tehillimTexts[chapterNum],
                        campaign_url: `${window.location.origin}${window.location.pathname}?campaign=${campaign.id}`,
                        message: `×§×™×‘×œ×ª ××ª ×¤×¨×§ ${chapterNum} ××ª×”×™×œ×™× ×¢×‘×•×¨ ×§××¤×™×™×Ÿ "${campaign.name}". ××—×¨×™ ×©×ª×¡×™×™× ×œ×§×¨×•×, ×—×–×•×¨ ×œ××ª×¨ ×•×¡××Ÿ ×›××•×©×œ×.`,
                        subject: `×¤×¨×§ ${chapterNum} ××ª×”×™×œ×™× - ${campaign.name}`
                    };

                    try {
                        await emailjs.send(
                            this.emailConfig.serviceId,
                            this.emailConfig.chapterTakenTemplateId,
                            userParams
                        );
                        console.log('Chapter text sent to participant');
                    } catch (error) {
                        console.error('Chapter text email failed:', error);
                    }
                }
            }

            async sendChapterCompletedEmail(campaign, chapterNum, userName) {
                if (!this.emailConfig) return;

                const templateParams = {
                    to_name: campaign.organizer,
                    to_email: campaign.organizerEmail,
                    campaign_name: campaign.name,
                    chapter_number: chapterNum,
                    user_name: userName,
                    message: `${userName} ×¡×™×™× ×œ×§×¨×•× ×¤×¨Ù‚ ${chapterNum} ×‘×§××¤×™×™×Ÿ "${campaign.name}"!`
                };

                try {
                    await emailjs.send(
                        this.emailConfig.serviceId,
                        this.emailConfig.templateId,
                        templateParams
                    );
                } catch (error) {
                    console.error('Email send failed:', error);
                }
            }

            initializeChapters() {
                const chapters = {};
                for (let i = 1; i <= 150; i++) {
                    chapters[i] = {
                        status: 'available', // available, taken, completed
                        takenBy: null,
                        takenByEmail: null,
                        completedAt: null
                    };
                }
                return chapters;
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            getCampaigns() {
                const campaigns = localStorage.getItem('tehillimCampaigns');
                return campaigns ? JSON.parse(campaigns) : {};
            }

            showCampaignUrl(campaignId) {
                const baseUrl = window.location.origin + window.location.pathname;
                const campaignUrl = `${baseUrl}?campaign=${campaignId}`;
                
                document.getElementById('campaignUrl').textContent = campaignUrl;
                document.getElementById('createSection').classList.add('hidden');
                document.getElementById('urlSection').classList.remove('hidden');
                
                this.currentCampaignId = campaignId;
            }

            loadCampaign(campaignId) {
                const campaigns = this.getCampaigns();
                const campaign = campaigns[campaignId];

                if (!campaign) {
                    alert('×§××¤×™×™×Ÿ ×œ× × ××¦×');
                    return;
                }

                this.currentCampaignId = campaignId;
                this.displayCampaign(campaign);
            }

            displayCampaign(campaign) {
                document.getElementById('createSection').classList.add('hidden');
                document.getElementById('urlSection').classList.add('hidden');
                document.getElementById('campaignSection').classList.remove('hidden');

                // Display campaign info
                const infoDiv = document.getElementById('campaignInfo');
                infoDiv.innerHTML = `
                    <h2>${campaign.name}</h2>
                    ${campaign.description ? `<p><strong>×ª×™××•×¨:</strong> ${campaign.description}</p>` : ''}
                    <p><strong>×××¨×’×Ÿ:</strong> ${campaign.organizer}</p>
                    <p><strong>× ×•×¦×¨:</strong> ${new Date(campaign.created).toLocaleDateString('he-IL')}</p>
                `;

                // Display chapters
                this.displayChapters(campaign.chapters);
                this.updateProgress(campaign.chapters);
            }

            displayChapters(chapters) {
                const grid = document.getElementById('chaptersGrid');
                grid.innerHTML = '';

                for (let i = 1; i <= 150; i++) {
                    const chapter = chapters[i];
                    const btn = document.createElement('div');
                    btn.className = `chapter-btn ${chapter.status}`;
                    btn.textContent = i;
                    btn.onclick = () => this.handleChapterClick(i);
                    
                    if (chapter.status === 'taken') {
                        btn.title = `× ×œ×§×— ×¢×œ ×™×“×™: ${chapter.takenBy || '××œ××•× ×™'}`;
                    } else if (chapter.status === 'completed') {
                        btn.title = `×”×•×©×œ× ×¢×œ ×™×“×™: ${chapter.takenBy || '××œ××•× ×™'}`;
                    }
                    
                    grid.appendChild(btn);
                }
            }

            handleChapterClick(chapterNum) {
                const campaigns = this.getCampaigns();
                const campaign = campaigns[this.currentCampaignId];
                const chapter = campaign.chapters[chapterNum];

                if (chapter.status === 'available') {
                    this.takeChapter(chapterNum);
                } else if (chapter.status === 'taken') {
                    this.showChapterText(chapterNum);
                } else {
                    alert('×¤×¨×§ ×–×” ×›×‘×¨ ×”×•×©×œ×');
                }
            }

            takeChapter(chapterNum) {
                const name = document.getElementById('participantName').value.trim();
                const email = document.getElementById('participantEmail').value.trim();
                
                if (!name) {
                    alert('×× × ×”×›× ×¡ ××ª ×©××š ×‘×©×“×” ×œ××¢×œ×”');
                    document.getElementById('participantName').focus();
                    return;
                }
                
                if (!email) {
                    alert('×× × ×”×›× ×¡ ××ª ×›×ª×•×‘×ª ×”××™×™×œ ×©×œ×š ×‘×©×“×” ×œ××¢×œ×”');
                    document.getElementById('participantEmail').focus();
                    return;
                }
                
                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('×× × ×”×›× ×¡ ×›×ª×•×‘×ª ××™×™×œ ×ª×§×™× ×”');
                    document.getElementById('participantEmail').focus();
                    return;
                }

                const campaigns = this.getCampaigns();
                const campaign = campaigns[this.currentCampaignId];
                const chapter = campaign.chapters[chapterNum];

                chapter.status = 'taken';
                chapter.takenBy = name;
                chapter.takenByEmail = email;

                // Save changes
                localStorage.setItem('tehillimCampaigns', JSON.stringify(campaigns));
                
                // Send emails
                this.sendChapterTakenEmail(campaign, chapterNum, name, email);

                // Refresh display
                this.displayChapters(campaign.chapters);
                this.updateProgress(campaign.chapters);

                // Show success message
                alert(`×¤×¨×§ ${chapterNum} × ×œ×§×— ×‘×”×¦×œ×—×”! ×”×˜×§×¡×˜ ×”××œ× × ×©×œ×— ××œ×™×š ×‘××™×™×œ.`);

                // Clear the input fields for next user
                document.getElementById('participantName').value = '';
                document.getElementById('participantEmail').value = '';
            }

            showChapterText(chapterNum) {
                this.currentChapterNum = chapterNum;
                
                document.getElementById('chapterTitle').textContent = `×ª×”×™×œ×™× ×¤×¨×§ ${chapterNum}`;
                document.getElementById('chapterContent').textContent = this.tehillimTexts[chapterNum];
                document.getElementById('chapterModal').style.display = 'block';

                // Set up complete button
                document.getElementById('completeChapterBtn').onclick = () => this.completeChapter(chapterNum);
            }

            completeChapter(chapterNum) {
                const campaigns = this.getCampaigns();
                const campaign = campaigns[this.currentCampaignId];
                const chapter = campaign.chapters[chapterNum];

                if (chapter.status !== 'taken') {
                    alert('×œ× × ×™×ª×Ÿ ×œ×¡××Ÿ ×¤×¨×§ ×©×œ× × ×œ×§×—');
                    return;
                }

                const confirm = window.confirm(`×”×× ×¡×™×™××ª ×œ×§×¨×•× ×¤×¨×§ ${chapterNum}?`);
                if (!confirm) return;

                chapter.status = 'completed';
                chapter.completedAt = new Date().toISOString();

                // Save changes
                localStorage.setItem('tehillimCampaigns', JSON.stringify(campaigns));

                // Send completion email
                this.sendChapterCompletedEmail(campaign, chapterNum, chapter.takenBy);

                // Refresh display
                this.displayChapters(campaign.chapters);
                this.updateProgress(campaign.chapters);

                // Close modal
                this.closeChapterModal();

                alert('×ª×•×“×” ×¢×œ ×”×©×œ××ª ×”×¤×¨×§!');
            }

            closeChapterModal() {
                document.getElementById('chapterModal').style.display = 'none';
            }

            updateProgress(chapters) {
                const total = 150;
                const taken = Object.values(chapters).filter(ch => ch.status === 'taken' || ch.status === 'completed').length;
                const available = total - taken;

                const percentage = (taken / total) * 100;
                
                document.getElementById('progressFill').style.width = `${percentage}%`;
                document.getElementById('progressText').innerHTML = `
                    × ×œ×§×—×•: ${taken} | ×–××™× ×™×: ${available} | ×¡×”"×›: ${total} (${Math.round(percentage)}%)
                `;
            }

            displayExistingCampaigns() {
                console.log('Displaying existing campaigns...');
                const campaigns = this.getCampaigns();
                console.log('Found campaigns:', JSON.stringify(campaigns, null, 2));
                
                const listDiv = document.getElementById('campaignsList');
                
                const campaignIds = Object.keys(campaigns || {});
                console.log('Campaign IDs:', campaignIds);
                
                if (campaignIds.length === 0) {
                    listDiv.innerHTML = '<p>××™×Ÿ ×§××¤×™×™× ×™× ×§×™×™××™×</p>';
                    return;
                }

                listDiv.innerHTML = '';
                campaignIds.forEach(id => {
                    const campaign = campaigns[id];
                    if (!campaign || !campaign.chapters) {
                        console.error('Invalid campaign data for ID:', id);
                        return;
                    }
                    
                    const completed = Object.values(campaign.chapters).filter(ch => ch && ch.status === 'completed').length;
                    const percentage = Math.round((completed / 150) * 100);

                    const item = document.createElement('div');
                    item.className = 'campaign-item';
                    item.onclick = () => this.loadCampaign(id);
                    item.innerHTML = `
                        <strong>${campaign.name || '×œ×œ× ×©×'}</strong><br>
                        <small>×××¨×’×Ÿ: ${campaign.organizer || '×œ× ×™×“×•×¢'} | ×”×•×©×œ××•: ${completed}/150 (${percentage}%)</small>
                    `;
                    listDiv.appendChild(item);
                });
                
                console.log('Existing campaigns displayed');
            }

            showCreateForm() {
                document.getElementById('campaignSection').classList.add('hidden');
                document.getElementById('urlSection').classList.add('hidden');
                document.getElementById('createSection').classList.remove('hidden');
                
                // Clear URL parameter
                window.history.pushState({}, document.title, window.location.pathname);
            }

            getTehillimTexts() {
                const texts = {};
                
                // Chapter 1 - Based on traditional Hebrew text
                texts[1] = `××–××•×¨ ×
×Ö·×©Ö°××¨Öµ×™ ×”Ö¸×Ö´×™×©× ×Ö²×©Ö¶××¨ ×œÖ¹× ×”Ö¸×œÖ·×šÖ° ×‘Ö·Ö¼×¢Ö²×¦Ö·×ª ×¨Ö°×©Ö¸××¢Ö´×™× ×•Ö¼×‘Ö°×“Ö¶×¨Ö¶×šÖ° ×—Ö·×˜Ö¸Ö¼×Ö´×™× ×œÖ¹× ×¢Ö¸×Ö¸×“ ×•Ö¼×‘Ö°××•Ö¹×©Ö·××‘ ×œÖµ×¦Ö´×™× ×œÖ¹× ×™Ö¸×©Ö¸××‘:
×›Ö´Ö¼×™ ×Ö´× ×‘Ö°Ö¼×ª×•Ö¹×¨Ö·×ª ×™Ö°×”×•Ö¸×” ×—Ö¶×¤Ö°×¦×•Ö¹ ×•Ö¼×‘Ö°×ª×•Ö¹×¨Ö¸×ª×•Ö¹ ×™Ö¶×”Ö°×’Ö¶Ö¼×” ×™×•Ö¹×Ö¸× ×•Ö¸×œÖ¸×™Ö°×œÖ¸×”:
×•Ö°×”Ö¸×™Ö¸×” ×›Ö°Ö¼×¢Öµ×¥ ×©Ö¸××ª×•Ö¼×œ ×¢Ö·×œ ×¤Ö·Ö¼×œÖ°×’Öµ×™ ×Ö¸×™Ö´× ×Ö²×©Ö¶××¨ ×¤Ö´Ö¼×¨Ö°×™×•Ö¹ ×™Ö´×ªÖµÖ¼×Ÿ ×‘Ö°Ö¼×¢Ö´×ªÖ¼×•Ö¹ ×•Ö°×¢Ö¸×œÖµ×”×•Ö¼ ×œÖ¹× ×™Ö´×‘Ö¼×•Ö¹×œ ×•Ö°×›Ö¹×œ ×Ö²×©Ö¶××¨ ×™Ö·×¢Ö²×©Ö¶×‚×” ×™Ö·×¦Ö°×œÖ´×™×—Ö·:
×œÖ¹× ×›Öµ×Ÿ ×”Ö¸×¨Ö°×©Ö¸××¢Ö´×™× ×›Ö´Ö¼×™ ×Ö´× ×›Ö·Ö¼×Ö¹Ö¼×¥ ×Ö²×©Ö¶××¨ ×ªÖ´Ö¼×“Ö°Ö¼×¤Ö¶× Ö¼×•Ö¼ ×¨×•Ö¼×—Ö·:
×¢Ö·×œ ×›ÖµÖ¼×Ÿ ×œÖ¹× ×™Ö¸×§Ö»××•Ö¼ ×¨Ö°×©Ö¸××¢Ö´×™× ×‘Ö·Ö¼×Ö´Ö¼×©Ö°××¤Ö¸Ö¼×˜ ×•Ö°×—Ö·×˜Ö¸Ö¼×Ö´×™× ×‘Ö·Ö¼×¢Ö²×“Ö·×ª ×¦Ö·×“Ö´Ö¼×™×§Ö´×™×:
×›Ö´Ö¼×™ ×™×•Ö¹×“Öµ×¢Ö· ×™Ö°×”×•Ö¸×” ×“Ö¶Ö¼×¨Ö¶×šÖ° ×¦Ö·×“Ö´Ö¼×™×§Ö´×™× ×•Ö°×“Ö¶×¨Ö¶×šÖ° ×¨Ö°×©Ö¸××¢Ö´×™× ×ªÖ¹Ö¼××‘Öµ×“:`;

                // Chapter 23 - Based on traditional Hebrew text  
                texts[23] = `××–××•×¨ ×›×’ - ×Ö´×–Ö°××•Ö¹×¨ ×œÖ°×“Ö¸×•Ö´×“
×™Ö°×”×•Ö¸×” ×¨Ö¹×¢Ö´×™ ×œÖ¹× ×Ö¶×—Ö°×¡Ö¸×¨:
×‘Ö´Ö¼× Ö°××•Ö¹×ª ×“Ö¶Ö¼×©Ö¶×× ×™Ö·×¨Ö°×‘Ö´Ö¼×™×¦Öµ× Ö´×™ ×¢Ö·×œ ×Öµ×™ ×Ö°× Ö»×—×•Ö¹×ª ×™Ö°× Ö·×”Ö²×œÖµ× Ö´×™:
× Ö·×¤Ö°×©Ö´××™ ×™Ö°×©××•Ö¹×‘Öµ×‘ ×™Ö·× Ö°×—Öµ× Ö´×™ ×‘Ö°×Ö·×¢Ö°×’Ö°Ö¼×œÖµ×™ ×¦Ö¶×“Ö¶×§ ×œÖ°×Ö·×¢Ö·×Ÿ ×©Ö°×××•Ö¹:
×’Ö·Ö¼× ×›Ö´Ö¼×™ ×Öµ×œÖµ×šÖ° ×‘Ö°Ö¼×’Öµ×™× ×¦Ö·×œÖ°×Ö¸×•Ö¶×ª ×œÖ¹× ×Ö´×™×¨Ö¸× ×¨Ö¸×¢ ×›Ö´Ö¼×™ ×Ö·×ªÖ¸Ö¼×” ×¢Ö´×Ö¸Ö¼×“Ö´×™ ×©Ö´××‘Ö°×˜Ö°×šÖ¸ ×•Ö¼×Ö´×©Ö°××¢Ö·× Ö°×ªÖ¶Ö¼×šÖ¸ ×”Öµ×Ö¸Ö¼×” ×™Ö°× Ö·×—Ö²×Ö»× Ö´×™:
×ªÖ·Ö¼×¢Ö²×¨Ö¹×šÖ° ×œÖ°×¤Ö¸× Ö·×™ ×©Ö»××œÖ°×—Ö¸×Ÿ × Ö¶×’Ö¶×“ ×¦Ö¹×¨Ö°×¨Ö¸×™ ×“Ö´Ö¼×©Ö·Ö¼×× Ö°×ªÖ¸Ö¼ ×‘Ö·×©Ö¶Ö¼××Ö¶×Ÿ ×¨Ö¹××©Ö´××™ ×›Ö¼×•Ö¹×¡Ö´×™ ×¨Ö°×•Ö¸×™Ö¸×”:
×Ö·×šÖ° ×˜×•Ö¹×‘ ×•Ö¸×—Ö¶×¡Ö¶×“ ×™Ö´×¨Ö°×“Ö°Ö¼×¤×•Ö¼× Ö´×™ ×›Ö¸Ö¼×œ ×™Ö°×Öµ×™ ×—Ö·×™Ö¸Ö¼×™ ×•Ö°×©Ö·××‘Ö°×ªÖ´Ö¼×™ ×‘Ö°Ö¼×‘Öµ×™×ª ×™Ö°×”×•Ö¸×” ×œÖ°×Ö¹×¨Ö¶×šÖ° ×™Ö¸×Ö´×™×:`;

                // Chapter 91 - Based on traditional Hebrew text
                texts[91] = `××–××•×¨ ×¦×
×™Ö¹×©Öµ××‘ ×‘Ö°Ö¼×¡Öµ×ªÖ¶×¨ ×¢Ö¶×œÖ°×™×•Ö¹×Ÿ ×‘Ö°Ö¼×¦Öµ×œ ×©Ö·××“Ö·Ö¼×™ ×™Ö´×ªÖ°×œ×•Ö¹× Ö¸×Ÿ:
×Ö¹×Ö·×¨ ×œÖ·×™×”×•Ö¸×” ×Ö·×—Ö°×¡Ö´×™ ×•Ö¼×Ö°×¦×•Ö¼×“Ö¸×ªÖ´×™ ×Ö±×œÖ¹×”Ö·×™ ×Ö¶×‘Ö°×˜Ö·×— ×‘Ö¼×•Ö¹:
×›Ö´Ö¼×™ ×”×•Ö¼× ×™Ö·×¦Ö´Ö¼×™×œÖ°×šÖ¸ ×Ö´×¤Ö·Ö¼×— ×™Ö¸×§×•Ö¼×©× ×Ö´×“Ö¶Ö¼×‘Ö¶×¨ ×”Ö·×•Ö¼×•Ö¹×ª:
×‘Ö°Ö¼×Ö¶×‘Ö°×¨Ö¸×ª×•Ö¹ ×™Ö¸×¡Ö¶×šÖ° ×œÖ¸×šÖ° ×•Ö°×ªÖ·×—Ö·×ª ×›Ö°Ö¼× Ö¸×¤Ö¸×™×• ×ªÖ¶Ö¼×—Ö°×¡Ö¶×” ×¦Ö´× Ö¸Ö¼×” ×•Ö°×¡Ö¹×—Öµ×¨Ö¸×” ×Ö²×Ö´×ªÖ¼×•Ö¹:
×œÖ¹× ×ªÖ´×™×¨Ö¸× ×Ö´×¤Ö·Ö¼×—Ö·×“ ×œÖ¸×™Ö°×œÖ¸×” ×Öµ×—Öµ×¥ ×™Ö¸×¢×•Ö¼×£ ×™×•Ö¹×Ö¸×:
×Ö´×“Ö¶Ö¼×‘Ö¶×¨ ×‘Ö¸Ö¼×Ö¹×¤Ö¶×œ ×™Ö·×”Ö²×œÖ¹×šÖ° ×Ö´×§Ö¶Ö¼×˜Ö¶×‘ ×™Ö¸×©××•Ö¼×“ ×¦Ö¸×”Ö³×¨Ö¸×™Ö´×:
×™Ö´×¤Ö¹Ö¼×œ ×Ö´×¦Ö´Ö¼×“Ö°Ö¼×šÖ¸ ×Ö¶×œÖ¶×£ ×•Ö¼×¨Ö°×‘Ö¸×‘Ö¸×” ×Ö´×™×Ö´×™× Ö¶×šÖ¸ ×Öµ×œÖ¶×™×šÖ¸ ×œÖ¹× ×™Ö´×’Ö¸Ö¼×©×:
×¨Ö·×§ ×‘Ö°Ö¼×¢Öµ×™× Ö¶×™×šÖ¸ ×ªÖ·×‘Ö´Ö¼×™×˜ ×•Ö°×©Ö´××œÖ»Ö¼×Ö·×ª ×¨Ö°×©Ö¸××¢Ö´×™× ×ªÖ´Ö¼×¨Ö°×Ö¶×”:
×›Ö´Ö¼×™ ×Ö·×ªÖ¸Ö¼×” ×™Ö°×”×•Ö¸×” ×Ö·×—Ö°×¡Ö´×™ ×¢Ö¶×œÖ°×™×•Ö¹×Ÿ ×©Ö·×‚×Ö°×ªÖ¸Ö¼ ×Ö°×¢×•Ö¹× Ö¶×šÖ¸:
×œÖ¹× ×ªÖ°×Ö»× Ö¶Ö¼×” ×Öµ×œÖ¶×™×šÖ¸ ×¨Ö¸×¢Ö¸×” ×•Ö°× Ö¶×’Ö·×¢ ×œÖ¹× ×™Ö´×§Ö°×¨Ö·×‘ ×‘Ö°Ö¼×Ö¸×”Ö³×œÖ¶×šÖ¸:
×›Ö´Ö¼×™ ×Ö·×œÖ°×Ö¸×›Ö¸×™×• ×™Ö°×¦Ö·×•Ö¶Ö¼×” ×œÖ¸Ö¼×šÖ° ×œÖ´×©Ö°××Ö¸×¨Ö°×šÖ¸ ×‘Ö°Ö¼×›Ö¸×œ ×“Ö°Ö¼×¨Ö¸×›Ö¶×™×šÖ¸:
×¢Ö·×œ ×›Ö·Ö¼×¤Ö·Ö¼×™Ö´× ×™Ö´×©Ö¸Ö¼×‚××•Ö¼× Ö°×šÖ¸ ×¤Ö¶Ö¼×Ÿ ×ªÖ´Ö¼×’Ö¹Ö¼×£ ×‘Ö¸Ö¼×Ö¶×‘Ö¶×Ÿ ×¨Ö·×’Ö°×œÖ¶×šÖ¸:
×¢Ö·×œ ×©Ö·××—Ö·×œ ×•Ö¸×¤Ö¶×ªÖ¶×Ÿ ×ªÖ´Ö¼×“Ö°×¨Ö¹×šÖ° ×ªÖ´Ö¼×¨Ö°×Ö¹×¡ ×›Ö°Ö¼×¤Ö´×™×¨ ×•Ö°×ªÖ·× Ö´Ö¼×™×Ÿ:
×›Ö´Ö¼×™ ×‘Ö´×™ ×—Ö¸×©Ö·××§ ×•Ö·×Ö²×¤Ö·×œÖ°Ö¼×˜Öµ×”×•Ö¼ ×Ö²×©Ö·×‚×’Ö°Ö¼×‘Öµ×”×•Ö¼ ×›Ö´Ö¼×™ ×™Ö¸×“Ö·×¢ ×©Ö°××Ö´×™:
×™Ö´×§Ö°×¨Ö¸×Öµ× Ö´×™ ×•Ö°×Ö¶×¢Ö±× Öµ×”×•Ö¼ ×¢Ö´×Ö¼×•Ö¹ ×Ö¸× Ö¹×›Ö´×™ ×‘Ö°×¦Ö¸×¨Ö¸×” ×Ö²×—Ö·×œÖ°Ö¼×¦Öµ×”×•Ö¼ ×•Ö·×Ö²×›Ö·×‘Ö°Ö¼×“Öµ×”×•Ö¼:
×Ö¹×¨Ö¶×šÖ° ×™Ö¸×Ö´×™× ×Ö·×©Ö°×‚×‘Ö´Ö¼×™×¢Öµ×”×•Ö¼ ×•Ö°×Ö·×¨Ö°×Öµ×”×•Ö¼ ×‘Ö´Ö¼×™×©××•Ö¼×¢Ö¸×ªÖ´×™:`;

                // Chapter 121 - Based on traditional Hebrew text
                texts[121] = `××–××•×¨ ×§×›× - ×©Ö´××™×¨ ×œÖ·×Ö·Ö¼×¢Ö²×œ×•Ö¹×ª
×Ö¶×©Ö¸Ö¼×‚× ×¢Öµ×™× Ö·×™ ×Ö¶×œ ×”Ö¶×”Ö¸×¨Ö´×™× ×Öµ×Ö·×™Ö´×Ÿ ×™Ö¸×‘Ö¹× ×¢Ö¶×–Ö°×¨Ö´×™:
×¢Ö¶×–Ö°×¨Ö´×™ ×Öµ×¢Ö´× ×™Ö°×”×•Ö¸×” ×¢Ö¹×©Öµ×‚×” ×©Ö¸××Ö·×™Ö´× ×•Ö¸×Ö¸×¨Ö¶×¥:
×Ö·×œ ×™Ö´×ªÖµÖ¼×Ÿ ×œÖ·×Ö¼×•Ö¹×˜ ×¨Ö·×’Ö°×œÖ¶×šÖ¸ ×Ö·×œ ×™Ö¸× ×•Ö¼× ×©Ö¹××Ö°×¨Ö¶×šÖ¸:
×”Ö´× ÖµÖ¼×” ×œÖ¹× ×™Ö¸× ×•Ö¼× ×•Ö°×œÖ¹× ×™Ö´×™×©Ö¸××Ÿ ×©××•Ö¹×Öµ×¨ ×™Ö´×©Ö°×‚×¨Ö¸×Öµ×œ:
×™Ö°×”×•Ö¸×” ×©Ö¹××Ö°×¨Ö¶×šÖ¸ ×™Ö°×”×•Ö¸×” ×¦Ö´×œÖ°Ö¼×šÖ¸ ×¢Ö·×œ ×™Ö·×“ ×™Ö°×Ö´×™× Ö¶×šÖ¸:
×™×•Ö¹×Ö¸× ×”Ö·×©Ö¶Ö¼××Ö¶×©× ×œÖ¹× ×™Ö·×›Ö¶Ö¼×›Ö¸Ö¼×” ×•Ö°×™Ö¸×¨Öµ×—Ö· ×‘Ö·Ö¼×œÖ¸Ö¼×™Ö°×œÖ¸×”:
×™Ö°×”×•Ö¸×” ×™Ö´×©Ö°××Ö¸×¨Ö°×šÖ¸ ×Ö´×›Ö¸Ö¼×œ ×¨Ö¸×¢ ×™Ö´×©Ö°××Ö¹×¨ ×Ö¶×ª × Ö·×¤Ö°×©Ö¶××šÖ¸:
×™Ö°×”×•Ö¸×” ×™Ö´×©Ö°××Ö¸×¨ ×¦Öµ××ªÖ°×šÖ¸ ×•Ö¼×‘×•Ö¹×Ö¶×šÖ¸ ×Öµ×¢Ö·×ªÖ¸Ö¼×” ×•Ö°×¢Ö·×“ ×¢×•Ö¹×œÖ¸×:`;

                // For the remaining chapters, provide instructions and a few more examples
                const popularChapters = {
                    2: `××–××•×¨ ×‘\n×œÖ¸×Ö¸Ö¼×” ×¨Ö¸×’Ö°×©××•Ö¼ ×’×•Ö¹×™Ö´× ×•Ö¼×œÖ°×Ö»×Ö´Ö¼×™× ×™Ö¶×”Ö°×’Ö¼×•Ö¼ ×¨Ö´×™×§:\n×™Ö´×ªÖ°×™Ö·×¦Ö°Ö¼×‘×•Ö¼ ×Ö·×œÖ°×›Öµ×™ ×Ö¶×¨Ö¶×¥ ×•Ö°×¨×•Ö¹×–Ö°× Ö´×™× × ×•Ö¹×¡Ö°×“×•Ö¼ ×™Ö¸×—Ö·×“ ×¢Ö·×œ ×™Ö°×”×•Ö¸×” ×•Ö°×¢Ö·×œ ×Ö°×©Ö´××™×—×•Ö¹:\n× Ö°× Ö·×ªÖ°Ö¼×§Ö¸×” ×Ö¶×ª ××•Ö¹×¡Ö°×¨×•Ö¹×ªÖµ×™××•Ö¹ ×•Ö°× Ö·×©Ö°××œÖ´×™×›Ö¸×” ×Ö´×Ö¶Ö¼× Ö¼×•Ö¼ ×¢Ö²×‘Ö¹×ªÖµ×™××•Ö¹:\n×™×•Ö¹×©Öµ××‘ ×‘Ö·Ö¼×©Ö¸Ö¼××Ö·×™Ö´× ×™Ö´×©Ö°×‚×—Ö¸×§ ×Ö²×“Ö¹× Ö¸×™ ×™Ö´×œÖ°×¢Ö·×’ ×œÖ¸××•Ö¹:\n×Ö¸×– ×™Ö°×“Ö·×‘ÖµÖ¼×¨ ×Öµ×œÖµ×™××•Ö¹ ×‘Ö°×Ö·×¤Ö¼×•Ö¹ ×•Ö¼×‘Ö·×—Ö²×¨×•Ö¹× ×•Ö¹ ×™Ö°×‘Ö·×”Ö²×œÖµ××•Ö¹:\n×•Ö·×Ö²× Ö´×™ × Ö¸×¡Ö·×›Ö°×ªÖ´Ö¼×™ ×Ö·×œÖ°×›Ö´Ö¼×™ ×¢Ö·×œ ×¦Ö´×™Ö¼×•Ö¹×Ÿ ×”Ö·×¨ ×§Ö¸×“Ö°×©Ö´××™:\n×Ö²×¡Ö·×¤Ö°Ö¼×¨Ö¸×” ×Ö¶×œ ×—Ö¹×§ ×™Ö°×”×•Ö¸×” ×Ö¸×Ö·×¨ ×Öµ×œÖ·×™ ×‘Ö°Ö¼× Ö´×™ ×Ö·×ªÖ¸Ö¼×” ×Ö²× Ö´×™ ×”Ö·×™Ö¼×•Ö¹× ×™Ö°×œÖ´×“Ö°×ªÖ´Ö¼×™×šÖ¸:\n×©Ö°××Ö·×œ ×Ö´×Ö¶Ö¼× Ö´Ö¼×™ ×•Ö°×Ö¶×ªÖ°Ö¼× Ö¸×” ×’×•Ö¹×™Ö´× × Ö·×—Ö²×œÖ¸×ªÖ¶×šÖ¸ ×•Ö·×Ö²×—Ö»×–Ö¸Ö¼×ªÖ°×šÖ¸ ×Ö·×¤Ö°×¡Öµ×™ ×Ö¸×¨Ö¶×¥:\n×ªÖ°Ö¼×¨Ö¹×¢Öµ× ×‘Ö°Ö¼×©Öµ××‘Ö¶×˜ ×‘Ö·Ö¼×¨Ö°×–Ö¶×œ ×›Ö´Ö¼×›Ö°×œÖ´×™ ×™×•Ö¹×¦Öµ×¨ ×ªÖ°Ö¼× Ö·×¤Ö°Ö¼×¦Öµ×:\n×•Ö°×¢Ö·×ªÖ¸Ö¼×” ×Ö°×œÖ¸×›Ö´×™× ×”Ö·×©Ö°×‚×›Ö´Ö¼×™×œ×•Ö¼ ×”Ö´×•Ö¸Ö¼×¡Ö°×¨×•Ö¼ ×©Ö¹××¤Ö°×˜Öµ×™ ×Ö¸×¨Ö¶×¥:\n×¢Ö´×‘Ö°×“×•Ö¼ ×Ö¶×ª ×™Ö°×”×•Ö¸×” ×‘Ö°Ö¼×™Ö´×¨Ö°×Ö¸×” ×•Ö°×’Ö´×™×œ×•Ö¼ ×‘Ö´Ö¼×¨Ö°×¢Ö¸×“Ö¸×”:\n× Ö·×©Ö°Ö¼××§×•Ö¼ ×‘Ö·×¨ ×¤Ö¶Ö¼×Ÿ ×™Ö¶×Ö±× Ö·×£ ×•Ö°×ªÖ¹××‘Ö°×“×•Ö¼ ×“Ö¶×¨Ö¶×šÖ° ×›Ö´Ö¼×™ ×™Ö´×‘Ö°×¢Ö·×¨ ×›Ö´Ö¼×Ö°×¢Ö·×˜ ×Ö·×¤Ö¼×•Ö¹ ×Ö·×©Ö°××¨Öµ×™ ×›Ö¸Ö¼×œ ×—×•Ö¹×¡Öµ×™ ×‘×•Ö¹:`,
                    
                    3: `××–××•×¨ ×’ - ×Ö´×–Ö°××•Ö¹×¨ ×œÖ°×“Ö¸×•Ö´×“ ×‘Ö°Ö¼×‘Ö¸×¨Ö°×—×•Ö¹ ×Ö´×¤Ö°Ö¼× Öµ×™ ×Ö·×‘Ö°×©Ö¸××œ×•Ö¹× ×‘Ö°Ö¼× ×•Ö¹\n×™Ö°×”×•Ö¸×” ×Ö¸×” ×¨Ö·×‘Ö¼×•Ö¼ ×¦Ö¸×¨Ö¸×™ ×¨Ö·×‘Ö´Ö¼×™× ×§Ö¸×Ö´×™× ×¢Ö¸×œÖ¸×™:\n×¨Ö·×‘Ö´Ö¼×™× ×Ö¹×Ö°×¨Ö´×™× ×œÖ°× Ö·×¤Ö°×©Ö´××™ ×Öµ×™×Ÿ ×™Ö°×©××•Ö¼×¢Ö¸×ªÖ¸×” ×œÖ¼×•Ö¹ ×‘Öµ××œÖ¹×”Ö´×™× ×¡Ö¶×œÖ¸×”:\n×•Ö°×Ö·×ªÖ¸Ö¼×” ×™Ö°×”×•Ö¸×” ×Ö¸×’Öµ×Ÿ ×‘Ö·Ö¼×¢Ö²×“Ö´×™ ×›Ö°×‘×•Ö¹×“Ö´×™ ×•Ö¼×Öµ×¨Ö´×™× ×¨Ö¹××©Ö´××™:\n×§×•Ö¹×œÖ´×™ ×Ö¶×œ ×™Ö°×”×•Ö¸×” ×Ö¶×§Ö°×¨Ö¸× ×•Ö·×™Ö·Ö¼×¢Ö²× Öµ× Ö´×™ ×Öµ×”Ö·×¨ ×§Ö¸×“Ö°×©××•Ö¹ ×¡Ö¶×œÖ¸×”:\n×Ö²× Ö´×™ ×©Ö¸××›Ö·×‘Ö°×ªÖ´Ö¼×™ ×•Ö¸×Ö´×™×©Ö¸×× Ö¸×” ×”Ö±×§Ö´×™×¦×•Ö¹×ªÖ´×™ ×›Ö´Ö¼×™ ×™Ö°×”×•Ö¸×” ×™Ö´×¡Ö°×Ö°×›Öµ× Ö´×™:\n×œÖ¹× ×Ö´×™×¨Ö¸× ×Öµ×¨Ö´×‘Ö°×‘×•Ö¹×ª ×¢Ö¸× ×Ö²×©Ö¶××¨ ×¡Ö¸×‘Ö´×™×‘ ×©Ö¸××ª×•Ö¼ ×¢Ö¸×œÖ¸×™:\n×§×•Ö¼×Ö¸×” ×™Ö°×”×•Ö¸×” ×”×•Ö¹×©Ö´××™×¢Öµ× Ö´×™ ×Ö±×œÖ¹×”Ö·×™ ×›Ö´Ö¼×™ ×”Ö´×›Ö´Ö¼×™×ªÖ¸ ×Ö¶×ª ×›Ö¸Ö¼×œ ×Ö¹×™Ö°×‘Ö·×™ ×œÖ¶×—Ö´×™ ×©Ö´×× ÖµÖ¼×™ ×¨Ö°×©Ö¸××¢Ö´×™× ×©Ö´××‘Ö·Ö¼×¨Ö°×ªÖ¸Ö¼:\n×œÖ·×™×”×•Ö¸×” ×”Ö·×™Ö°×©××•Ö¼×¢Ö¸×” ×¢Ö·×œ ×¢Ö·×Ö°Ö¼×šÖ¸ ×‘Ö´×¨Ö°×›Ö¸×ªÖ¶×šÖ¸ ×¡Ö¶×œÖ¸×”:`
                };

                // Add popular chapters
                Object.assign(texts, popularChapters);

                // Fill remaining chapters with instructions
                for (let i = 1; i <= 150; i++) {
                    if (!texts[i]) {
                        texts[i] = `××–××•×¨ ${i}

×œ×”×©×œ××ª ×”×˜×§×¡×˜×™× ×”××œ××™×:
1. ×”×™×›× ×¡ ×œ××ª×¨: https://mechon-mamre.org/p/pt/pt26${String(i).padStart(2, '0')}.htm
2. ×”×¢×ª×§ ××ª ×”×˜×§×¡×˜ ×”×¢×‘×¨×™ ××”××ª×¨
3. ×”×—×œ×£ ××ª ×”×•×“×¢×” ×–×• ×‘×˜×§×¡×˜ ×”××œ× ×©×œ ×¤×¨×§ ${i}

×œ×“×•×’××”, ×¢×‘×•×¨ ×¤×¨×§ ${i} ×™×© ×œ×—×¤×© ×‘×›×ª×•×‘×ª:
https://mechon-mamre.org/p/pt/pt26${String(Math.floor(i/100))}${String(i%100).padStart(2, '0')}.htm

×¤×¨×§×™× ×©×›×‘×¨ ×”×•×›× ×¡×• ×‘××œ×•××: 1, 2, 3, 23, 91, 121

---
(×”×•×“×¢×” ×–×• ×ª×•×—×œ×£ ×‘×˜×§×¡×˜ ×”××œ× ×›×©×ª×¢×“×›×Ÿ ××ª ×”×§×•×“)`;
                    }
                }

                return texts;
            }
        }

        // Global functions
        function saveEmailConfig() {
            const userId = document.getElementById('emailjsUserId').value;
            const serviceId = document.getElementById('emailjsServiceId').value;
            const campaignCreatedTemplateId = document.getElementById('campaignCreatedTemplateId').value;
            const chapterTakenTemplateId = document.getElementById('chapterTakenTemplateId').value;
            const chapterCompletedTemplateId = document.getElementById('chapterCompletedTemplateId').value;

            if (!userId || !serviceId || !campaignCreatedTemplateId || !chapterTakenTemplateId || !chapterCompletedTemplateId) {
                alert('×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }

            console.log('Saving email config with multiple templates');

            const config = { 
                userId, 
                serviceId, 
                campaignCreatedTemplateId, 
                chapterTakenTemplateId, 
                chapterCompletedTemplateId 
            };
            localStorage.setItem('tehillimEmailConfig', JSON.stringify(config));
            
            window.tehillimPlatform.emailConfig = config;
            window.tehillimPlatform.initEmailJS();
            
            document.getElementById('emailSetup').style.display = 'none';
            
            // Test email immediately after saving config
            setTimeout(() => {
                testEmailConnection();
            }, 1000);
        }

        async function testEmailConnection() {
            console.log('=== TESTING EMAIL CONNECTION ===');
            
            if (!window.tehillimPlatform.emailConfig) {
                console.error('No email config for testing');
                return;
            }
            
            const testEmail = prompt('×”×›× ×¡ ×›×ª×•×‘×ª ××™×™×œ ×œ×‘×“×™×§×”:', 'test@example.com');
            if (!testEmail) return;
            
            const testParams = {
                to_email: testEmail,
                to_name: 'Test User',
                from_name: "×¤×œ×˜×¤×•×¨××ª ×ª×”×™×œ×™× - Test",
                campaign_name: 'Test Campaign',
                campaign_url: 'https://example.com/test',
                message: 'This is a test email to verify EmailJS configuration.',
                subject: 'Test Email - Tehillim Platform'
            };
            
            console.log('Test params:', JSON.stringify(testParams, null, 2));
            
            try {
                console.log('ğŸš€ Sending test email...');
                const result = await emailjs.send(
                    window.tehillimPlatform.emailConfig.serviceId,
                    window.tehillimPlatform.emailConfig.campaignCreatedTemplateId,
                    testParams
                );
                console.log('âœ… Test email sent successfully:', result);
                alert('×‘×“×™×§×ª ×”××™×™×œ ×”×¦×œ×™×—×”! ×‘×“×•×§ ××ª ×ª×™×‘×ª ×”×“×•××¨.');
            } catch (error) {
                console.error('âŒ Test email failed:', error);
                console.error('Error details:', JSON.stringify(error, null, 2));
                alert('×‘×“×™×§×ª ×”××™×™×œ × ×›×©×œ×”: ' + (error.text || error.message));
            }
        }

        function hideEmailSetup() {
            document.getElementById('emailSetup').style.display = 'none';
        }

        function copyUrl() {
            const url = document.getElementById('campaignUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—!');
            });
        }

        function goToCampaign() {
            const campaigns = window.tehillimPlatform.getCampaigns();
            const campaign = campaigns[window.tehillimPlatform.currentCampaignId];
            
            // Hide URL section and show campaign
            document.getElementById('urlSection').classList.add('hidden');
            window.tehillimPlatform.displayCampaign(campaign);
            
            // Update URL without page reload
            const baseUrl = window.location.origin + window.location.pathname;
            const newUrl = `${baseUrl}?campaign=${window.tehillimPlatform.currentCampaignId}`;
            window.history.pushState({}, document.title, newUrl);
        }

        function shareUrl() {
            const baseUrl = window.location.origin + window.location.pathname;
            const url = `${baseUrl}?campaign=${window.tehillimPlatform.currentCampaignId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: '×§××¤×™×™×Ÿ ×ª×”×™×œ×™×',
                    text: '×”×¦×˜×¨×£ ××œ×™ ×œ×§××¤×™×™×Ÿ ×ª×”×™×œ×™×',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—!');
                });
            }
        }

        function closeChapterModal() {
            document.getElementById('chapterModal').style.display = 'none';
        }

        // Initialize the platform
        window.tehillimPlatform = new TehillimPlatform();

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('chapterModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
